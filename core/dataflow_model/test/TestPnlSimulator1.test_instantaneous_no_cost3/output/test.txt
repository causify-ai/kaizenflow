df=
                          price         ask         bid
2021-09-12 09:30:00  100.496714  100.917359   99.413663
2021-09-12 09:31:00  100.358450  100.701164   99.304648
2021-09-12 09:32:00  101.006138  101.808416   99.628469
2021-09-12 09:33:00  102.529168  102.690454  101.591343
2021-09-12 09:34:00  102.295015  102.699066  101.779980
2021-09-12 09:35:00  102.060878  103.947064  101.547092
2021-09-12 09:36:00  103.640091  103.814669  103.125043
2021-09-12 09:37:00  104.407525  104.665076  100.554794
2021-09-12 09:38:00  103.938051  104.012497  103.367161
2021-09-12 09:39:00  104.480611  106.399382  103.345045
2021-09-12 09:40:00  104.017193  104.043707  103.063192
2021-09-12 09:41:00  103.551464  103.611694  102.900072
2021-09-12 09:42:00  103.793426  106.256668  103.478157
2021-09-12 09:43:00  101.880146  102.072507  101.121176
2021-09-12 09:44:00  100.155228  100.456775   99.382403
2021-09-12 09:45:00   99.592940   99.627652   99.356122
2021-09-12 09:46:00   98.580109   99.748787   98.094746
2021-09-12 09:47:00   98.894357  100.037179   98.812482
2021-09-12 09:48:00   97.986332   98.738266   95.671674
2021-09-12 09:49:00   96.574029   97.365061   94.706764
2021-09-12 09:50:00   98.039678   98.949065   97.353417
2021-09-12 09:51:00   97.813901   99.216696   96.201185
2021-09-12 09:52:00   97.881429   99.283281   97.409498
2021-09-12 09:53:00   96.456681   97.043538   95.367731
2021-09-12 09:54:00   95.912299   98.102754   95.848019
2021-09-12 09:55:00   96.023221   97.013757   94.945476
2021-09-12 09:56:00   94.872228   95.438525   94.156924
2021-09-12 09:57:00   95.247926   95.347577   94.568328
2021-09-12 09:58:00   94.647287   95.150763   93.916920
2021-09-12 09:59:00   94.355593   95.906257   94.139135
2021-09-12 10:00:00   93.753887   93.822449   93.708315
2021-09-12 10:01:00   95.606165   96.668468   94.954564
2021-09-12 10:02:00   95.592667   96.066260   93.448723
2021-09-12 10:03:00   94.534957   95.454381   93.901038
2021-09-12 10:04:00   95.357501   96.907436   93.332359
2021-09-12 10:05:00   94.136658   94.919911   93.950203
2021-09-12 10:06:00   94.345521   94.667583   93.683735
2021-09-12 10:07:00   92.385851   93.199368   91.533418
2021-09-12 10:08:00   91.057665   92.288530   90.265144
2021-09-12 10:09:00   91.254526   91.481986   91.139790
2021-09-12 10:10:00   91.992993   93.300136   91.488006
2021-09-12 10:11:00   92.164361   93.771845   91.298606
2021-09-12 10:12:00   92.048713   92.233347   90.848417
2021-09-12 10:13:00   91.747609   92.007492   91.413108
2021-09-12 10:14:00   90.269087   91.050910   89.794142
2021-09-12 10:15:00   89.549243   90.786194   88.895914
2021-09-12 10:16:00   89.088604   90.409061   87.323150
2021-09-12 10:17:00   90.145727   90.667668   89.740745
2021-09-12 10:18:00   90.489345   90.786330   89.228461
2021-09-12 10:19:00   88.726305   88.976798   87.808443
2021-09-12 10:20:00   89.050389   89.396837   86.928233
2021-09-12 10:21:00   88.665306   89.345331   87.632841
2021-09-12 10:22:00   87.988384   88.220638   86.469014
2021-09-12 10:23:00   88.600061   88.893133   88.115827
2021-09-12 10:24:00   89.631060   90.345412   88.364149
2021-09-12 10:25:00   90.562340   92.428115   89.854671
2021-09-12 10:26:00   89.723123   90.196956   89.279303
2021-09-12 10:27:00   89.413910   90.605214   88.639276
2021-09-12 10:28:00   89.745174   90.401727   88.818243
2021-09-12 10:29:00   90.720719   91.695401   90.661194
2021-09-12 10:30:00   90.241545   91.028629   87.000277
2021-09-12 10:31:00   90.055886   91.214481   89.031498
2021-09-12 10:32:00   88.949551   89.770233   88.696983
2021-09-12 10:33:00   87.753344   88.716720   86.505561
2021-09-12 10:34:00   88.565870   88.978651   86.933459
2021-09-12 10:35:00   89.922110   90.744170   88.491969
2021-09-12 10:36:00   89.850100   91.746893   89.410055
2021-09-12 10:37:00   90.853633   91.099021   90.722892
2021-09-12 10:38:00   91.215269   91.969005   89.773996
2021-09-12 10:39:00   90.570149   91.459664   89.134287
2021-09-12 10:40:00   90.931545   91.747355   89.768381
2021-09-12 10:41:00   92.469581   92.546683   92.459348
2021-09-12 10:42:00   92.433755   92.774907   91.452247
2021-09-12 10:43:00   93.998399   94.275090   93.536295
2021-09-12 10:44:00   91.378654   92.205837   91.179594
2021-09-12 10:45:00   92.200556   92.213558   91.600339
2021-09-12 10:46:00   92.287603   93.741137   92.217801
2021-09-12 10:47:00   91.988596   92.253253   91.603282
2021-09-12 10:48:00   92.080357   94.800526   91.966839
2021-09-12 10:49:00   90.092788   90.718455   89.430657
2021-09-12 10:50:00   89.873116   90.730274   88.287099
2021-09-12 10:51:00   90.230229   91.301121   88.992413
2021-09-12 10:52:00   91.708123   92.190595   89.575089
2021-09-12 10:53:00   91.189852   91.413315   89.237765
2021-09-12 10:54:00   90.381359   91.095359   90.229574
2021-09-12 10:55:00   89.879602   90.352839   89.291285
2021-09-12 10:56:00   90.795004   90.867833   90.514012
2021-09-12 10:57:00   91.123755   91.970549   90.501055
2021-09-12 10:58:00   90.593995   92.108842   90.385873
2021-09-12 10:59:00   91.107262   91.553777   90.614261
2021-09-12 11:00:00   91.204340   92.060739   90.614975
2021-09-12 11:01:00   92.172985   92.387078   91.323383
2021-09-12 11:02:00   91.470932   92.716670   91.113916
2021-09-12 11:03:00   91.143269   91.316450   90.450360
2021-09-12 11:04:00   90.751161   91.136479   89.851561
2021-09-12 11:05:00   89.287646   90.171504   88.980347
2021-09-12 11:06:00   89.583767   89.737492   88.770905
2021-09-12 11:07:00   89.844822   89.903031   89.215193
2021-09-12 11:08:00   89.849935   90.992906   89.020940
2021-09-12 11:09:00   89.615348   89.973136   89.055167
2021-09-12 11:10:00   88.199978   88.760762   87.452684
df_5mins=
                          price         ask         bid     ret_0  preds
2021-09-12 09:30:00  100.496714  100.917359   99.413663       NaN   -1.0
2021-09-12 09:35:00  102.060878  103.947064  101.547092  0.015564    1.0
2021-09-12 09:40:00  104.017193  104.043707  103.063192  0.019168    1.0
2021-09-12 09:45:00   99.592940   99.627652   99.356122 -0.042534    1.0
2021-09-12 09:50:00   98.039678   98.949065   97.353417 -0.015596   -1.0
2021-09-12 09:55:00   96.023221   97.013757   94.945476 -0.020568   -1.0
2021-09-12 10:00:00   93.753887   93.822449   93.708315 -0.023633   -1.0
2021-09-12 10:05:00   94.136658   94.919911   93.950203  0.004083    1.0
2021-09-12 10:10:00   91.992993   93.300136   91.488006 -0.022772    1.0
2021-09-12 10:15:00   89.549243   90.786194   88.895914 -0.026565    1.0
2021-09-12 10:20:00   89.050389   89.396837   86.928233 -0.005571   -1.0
2021-09-12 10:25:00   90.562340   92.428115   89.854671  0.016979    1.0
2021-09-12 10:30:00   90.241545   91.028629   87.000277 -0.003542    1.0
2021-09-12 10:35:00   89.922110   90.744170   88.491969 -0.003540   -1.0
2021-09-12 10:40:00   90.931545   91.747355   89.768381  0.011226   -1.0
2021-09-12 10:45:00   92.200556   92.213558   91.600339  0.013956   -1.0
2021-09-12 10:50:00   89.873116   90.730274   88.287099 -0.025243   -1.0
2021-09-12 10:55:00   89.879602   90.352839   89.291285  0.000072    1.0
2021-09-12 11:00:00   91.204340   92.060739   90.614975  0.014739   -1.0
2021-09-12 11:05:00   89.287646   90.171504   88.980347 -0.021015    0.0
2021-09-12 11:10:00   88.199978   88.760762   87.452684 -0.012182    0.0
# tot_ret=-0.07247354732087757
After pnl simulation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth   pnl.sim
2021-09-12 09:30:00  100.496714  100.917359   99.413663       NaN   -1.0    0.979807 -1.916812  98.083188       NaN
2021-09-12 09:35:00  102.060878  103.947064  101.547092  0.015564    1.0    0.942952 -4.171857  93.911331 -0.042534
2021-09-12 09:40:00  104.017193  104.043707  103.063192  0.019168    1.0    0.942952 -1.464652  92.446679 -0.015596
2021-09-12 09:45:00   99.592940   99.627652   99.356122 -0.042534    1.0    0.942952 -1.901421  90.545258 -0.020568
2021-09-12 09:50:00   98.039678   98.949065   97.353417 -0.015596   -1.0    0.942952  2.139873  92.685131  0.023633
2021-09-12 09:55:00   96.023221   97.013757   94.945476 -0.020568   -1.0    0.988600 -0.378408  92.306723 -0.004083
2021-09-12 10:00:00   93.753887   93.822449   93.708315 -0.023633   -1.0    0.980561  2.101994  94.408717  0.022772
2021-09-12 10:05:00   94.136658   94.919911   93.950203  0.004083    1.0    1.026260 -2.507922  91.900794 -0.026565
2021-09-12 10:10:00   91.992993   93.300136   91.488006 -0.022772    1.0    1.026260 -0.511954  91.388840 -0.005571
2021-09-12 10:15:00   89.549243   90.786194   88.895914 -0.026565    1.0    1.026260  1.551655  92.940495  0.016979
2021-09-12 10:20:00   89.050389   89.396837   86.928233 -0.005571   -1.0    1.026260  0.329220  93.269715  0.003542
2021-09-12 10:25:00   90.562340   92.428115   89.854671  0.016979    1.0    1.033556 -0.330154  92.939561 -0.003540
2021-09-12 10:30:00   90.241545   91.028629   87.000277 -0.003542    1.0    1.033556  1.043308  93.982869  0.011226
2021-09-12 10:35:00   89.922110   90.744170   88.491969 -0.003540   -1.0    1.033556 -1.311595  92.671274 -0.013956
2021-09-12 10:40:00   90.931545   91.747355   89.768381  0.011226   -1.0    1.005105  2.339323  95.010597  0.025243
2021-09-12 10:45:00   92.200556   92.213558   91.600339  0.013956   -1.0    1.057164 -0.006857  95.003740 -0.000072
2021-09-12 10:50:00   89.873116   90.730274   88.287099 -0.025243   -1.0    1.057011 -1.400263  93.603477 -0.014739
2021-09-12 10:55:00   89.879602   90.352839   89.291285  0.000072    1.0    1.026305 -1.967112  91.636365 -0.021015
2021-09-12 11:00:00   91.204340   92.060739   90.614975  0.014739   -1.0    1.026305  1.116280  92.752645  0.012182
2021-09-12 11:05:00   89.287646   90.171504   88.980347 -0.021015    0.0         NaN       NaN        NaN  0.000000
2021-09-12 11:10:00   88.199978   88.760762   87.452684 -0.012182    0.0         NaN       NaN        NaN  0.000000
After pnl lag computation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth   pnl.sim   pnl.lag
2021-09-12 09:30:00  100.496714  100.917359   99.413663       NaN   -1.0    0.979807 -1.916812  98.083188       NaN -0.019168
2021-09-12 09:35:00  102.060878  103.947064  101.547092  0.015564    1.0    0.942952 -4.171857  93.911331 -0.042534 -0.042534
2021-09-12 09:40:00  104.017193  104.043707  103.063192  0.019168    1.0    0.942952 -1.464652  92.446679 -0.015596 -0.015596
2021-09-12 09:45:00   99.592940   99.627652   99.356122 -0.042534    1.0    0.942952 -1.901421  90.545258 -0.020568 -0.020568
2021-09-12 09:50:00   98.039678   98.949065   97.353417 -0.015596   -1.0    0.942952  2.139873  92.685131  0.023633  0.023633
2021-09-12 09:55:00   96.023221   97.013757   94.945476 -0.020568   -1.0    0.988600 -0.378408  92.306723 -0.004083 -0.004083
2021-09-12 10:00:00   93.753887   93.822449   93.708315 -0.023633   -1.0    0.980561  2.101994  94.408717  0.022772  0.022772
2021-09-12 10:05:00   94.136658   94.919911   93.950203  0.004083    1.0    1.026260 -2.507922  91.900794 -0.026565 -0.026565
2021-09-12 10:10:00   91.992993   93.300136   91.488006 -0.022772    1.0    1.026260 -0.511954  91.388840 -0.005571 -0.005571
2021-09-12 10:15:00   89.549243   90.786194   88.895914 -0.026565    1.0    1.026260  1.551655  92.940495  0.016979  0.016979
2021-09-12 10:20:00   89.050389   89.396837   86.928233 -0.005571   -1.0    1.026260  0.329220  93.269715  0.003542  0.003542
2021-09-12 10:25:00   90.562340   92.428115   89.854671  0.016979    1.0    1.033556 -0.330154  92.939561 -0.003540 -0.003540
2021-09-12 10:30:00   90.241545   91.028629   87.000277 -0.003542    1.0    1.033556  1.043308  93.982869  0.011226  0.011226
2021-09-12 10:35:00   89.922110   90.744170   88.491969 -0.003540   -1.0    1.033556 -1.311595  92.671274 -0.013956 -0.013956
2021-09-12 10:40:00   90.931545   91.747355   89.768381  0.011226   -1.0    1.005105  2.339323  95.010597  0.025243  0.025243
2021-09-12 10:45:00   92.200556   92.213558   91.600339  0.013956   -1.0    1.057164 -0.006857  95.003740 -0.000072 -0.000072
2021-09-12 10:50:00   89.873116   90.730274   88.287099 -0.025243   -1.0    1.057011 -1.400263  93.603477 -0.014739 -0.014739
2021-09-12 10:55:00   89.879602   90.352839   89.291285  0.000072    1.0    1.026305 -1.967112  91.636365 -0.021015 -0.021015
2021-09-12 11:00:00   91.204340   92.060739   90.614975  0.014739   -1.0    1.026305  1.116280  92.752645  0.012182  0.012182
2021-09-12 11:05:00   89.287646   90.171504   88.980347 -0.021015    0.0         NaN       NaN        NaN  0.000000       NaN
2021-09-12 11:10:00   88.199978   88.760762   87.452684 -0.012182    0.0         NaN       NaN        NaN  0.000000       NaN
# tot_ret_lag=-0.07247354732087663