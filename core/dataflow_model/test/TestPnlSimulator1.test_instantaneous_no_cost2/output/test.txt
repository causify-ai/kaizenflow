df=
                          price         ask         bid
2021-09-12 09:30:00  100.257400  101.325113   99.879210
2021-09-12 09:31:00   99.348918  100.426519   98.112778
2021-09-12 09:32:00   98.970415   99.767189   98.280444
2021-09-12 09:33:00   98.435500   99.921542   98.237145
2021-09-12 09:34:00   99.293573   99.807702   96.267833
2021-09-12 09:35:00   98.880563   99.732354   97.634937
2021-09-12 09:36:00   99.378752  100.337425   97.294712
2021-09-12 09:37:00  101.388951  102.015435  101.284829
2021-09-12 09:38:00  102.651813  102.959744  102.501579
2021-09-12 09:39:00  102.212598  102.217803  102.106781
2021-09-12 09:40:00  101.866160  102.557692  101.429206
2021-09-12 09:41:00  102.321479  102.766342  101.302343
2021-09-12 09:42:00  100.652817  100.743096   99.420014
2021-09-12 09:43:00   99.790731  101.649074   99.716607
2021-09-12 09:44:00  100.283642  100.450222   99.687253
2021-09-12 09:45:00  100.159329  100.270205   99.979936
2021-09-12 09:46:00  102.094465  102.789238  102.003670
2021-09-12 09:47:00  101.476022  101.745198  100.650943
2021-09-12 09:48:00  100.429183  101.728408  100.094214
2021-09-12 09:49:00   99.539566   99.860671   98.821215
2021-09-12 09:50:00   99.553606  100.059475   97.534144
2021-09-12 09:51:00   99.392777  101.481836   99.234748
2021-09-12 09:52:00  101.623136  102.635845  101.038921
2021-09-12 09:53:00  101.224021  101.247995  101.153714
2021-09-12 09:54:00  101.278465  102.239934   99.505284
2021-09-12 09:55:00  102.162647  102.255213  101.716018
2021-09-12 09:56:00  102.054666  102.278398  100.565292
2021-09-12 09:57:00  102.610273  103.443165  101.509965
2021-09-12 09:58:00  103.005180  103.979300  102.975284
2021-09-12 09:59:00  103.842385  104.005203  103.755279
2021-09-12 10:00:00  102.434507  102.548999  102.253272
2021-09-12 10:01:00  103.242356  104.428825  102.417184
2021-09-12 10:02:00  103.104073  103.283864  102.477234
2021-09-12 10:03:00  103.291251  104.807693  102.678553
2021-09-12 10:04:00  102.904593  104.538625  102.868851
2021-09-12 10:05:00  104.563642  106.345613  102.367679
2021-09-12 10:06:00  102.516573  103.134300  101.653290
2021-09-12 10:07:00  103.915890  105.002289  103.380790
2021-09-12 10:08:00  103.236882  103.281636  102.113419
2021-09-12 10:09:00  104.765868  105.929570  104.431903
2021-09-12 10:10:00  105.987084  106.556023  105.479853
2021-09-12 10:11:00  107.002072  107.464716  106.011922
2021-09-12 10:12:00  107.830202  108.117557  106.572258
2021-09-12 10:13:00  110.096495  111.073834  109.918870
2021-09-12 10:14:00  109.501539  109.723975  109.486672
2021-09-12 10:15:00  108.920270  109.017201  108.879833
2021-09-12 10:16:00  108.264375  108.452760  108.242931
2021-09-12 10:17:00  109.189524  110.781126  107.997868
2021-09-12 10:18:00  107.890363  108.476174  105.385498
2021-09-12 10:19:00  108.901530  109.105205  107.568069
2021-09-12 10:20:00  108.613090  110.469610  107.584817
df_5mins=
                          price         ask         bid     ret_0  preds
2021-09-12 09:30:00  100.257400  101.325113   99.879210       NaN   -1.0
2021-09-12 09:35:00   98.880563   99.732354   97.634937 -0.013733    1.0
2021-09-12 09:40:00  101.866160  102.557692  101.429206  0.030194    1.0
2021-09-12 09:45:00  100.159329  100.270205   99.979936 -0.016756    1.0
2021-09-12 09:50:00   99.553606  100.059475   97.534144 -0.006048   -1.0
2021-09-12 09:55:00  102.162647  102.255213  101.716018  0.026207   -1.0
2021-09-12 10:00:00  102.434507  102.548999  102.253272  0.002661   -1.0
2021-09-12 10:05:00  104.563642  106.345613  102.367679  0.020785    1.0
2021-09-12 10:10:00  105.987084  106.556023  105.479853  0.013613    1.0
2021-09-12 10:15:00  108.920270  109.017201  108.879833  0.027675    0.0
2021-09-12 10:20:00  108.613090  110.469610  107.584817 -0.002820    0.0
# tot_ret=-0.039838541451383665
After pnl simulation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth  pnl.sim1
2021-09-12 09:30:00  100.257400  101.325113   99.879210       NaN   -1.0    1.011321 -3.019397  96.980603 -0.030194
2021-09-12 09:35:00   98.880563   99.732354   97.634937 -0.013733    1.0    0.952039 -1.624971  95.355633 -0.016756
2021-09-12 09:40:00  101.866160  102.557692  101.429206  0.030194    1.0    0.952039 -0.576672  94.778961 -0.006048
2021-09-12 09:45:00  100.159329  100.270205   99.979936 -0.016756    1.0    0.952039  2.483910  97.262871  0.026207
2021-09-12 09:50:00   99.553606  100.059475   97.534144 -0.006048   -1.0    0.952039 -0.258821  97.004049 -0.002661
2021-09-12 09:55:00  102.162647  102.255213  101.716018  0.026207   -1.0    0.946986 -2.016261  94.987788 -0.020785
2021-09-12 10:00:00  102.434507  102.548999  102.253272  0.002661   -1.0    0.908421 -1.293084  93.694704 -0.013613
2021-09-12 10:05:00  104.563642  106.345613  102.367679  0.020785    1.0    0.884020  2.592995  96.287699  0.027675
2021-09-12 10:10:00  105.987084  106.556023  105.479853  0.013613    1.0    0.884020 -0.271553  96.016146 -0.002820
2021-09-12 10:15:00  108.920270  109.017201  108.879833  0.027675    0.0         NaN       NaN        NaN  0.000000
2021-09-12 10:20:00  108.613090  110.469610  107.584817 -0.002820    0.0         NaN       NaN        NaN  0.000000
After pnl lag computation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth  pnl.sim1   pnl.lag
2021-09-12 09:30:00  100.257400  101.325113   99.879210       NaN   -1.0    1.011321 -3.019397  96.980603 -0.030194 -0.030194
2021-09-12 09:35:00   98.880563   99.732354   97.634937 -0.013733    1.0    0.952039 -1.624971  95.355633 -0.016756 -0.016756
2021-09-12 09:40:00  101.866160  102.557692  101.429206  0.030194    1.0    0.952039 -0.576672  94.778961 -0.006048 -0.006048
2021-09-12 09:45:00  100.159329  100.270205   99.979936 -0.016756    1.0    0.952039  2.483910  97.262871  0.026207  0.026207
2021-09-12 09:50:00   99.553606  100.059475   97.534144 -0.006048   -1.0    0.952039 -0.258821  97.004049 -0.002661 -0.002661
2021-09-12 09:55:00  102.162647  102.255213  101.716018  0.026207   -1.0    0.946986 -2.016261  94.987788 -0.020785 -0.020785
2021-09-12 10:00:00  102.434507  102.548999  102.253272  0.002661   -1.0    0.908421 -1.293084  93.694704 -0.013613 -0.013613
2021-09-12 10:05:00  104.563642  106.345613  102.367679  0.020785    1.0    0.884020  2.592995  96.287699  0.027675  0.027675
2021-09-12 10:10:00  105.987084  106.556023  105.479853  0.013613    1.0    0.884020 -0.271553  96.016146 -0.002820 -0.002820
2021-09-12 10:15:00  108.920270  109.017201  108.879833  0.027675    0.0         NaN       NaN        NaN  0.000000       NaN
2021-09-12 10:20:00  108.613090  110.469610  107.584817 -0.002820    0.0         NaN       NaN        NaN  0.000000       NaN
# tot_ret_lag=-0.03983854145138399