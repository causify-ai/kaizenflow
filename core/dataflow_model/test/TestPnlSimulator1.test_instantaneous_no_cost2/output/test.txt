df=
                          price         ask         bid
2021-09-12 09:30:00  100.496714  100.881796  100.154000
2021-09-12 09:31:00  100.358450  101.035372   99.556173
2021-09-12 09:32:00  101.006138  101.617815  100.844853
2021-09-12 09:33:00  102.529168  103.560168  102.125117
2021-09-12 09:34:00  102.295015  103.226295  100.408829
2021-09-12 09:35:00  102.060878  102.900095  101.886300
2021-09-12 09:36:00  103.640091  103.949303  103.382540
2021-09-12 09:37:00  104.407525  104.738789  104.333080
2021-09-12 09:38:00  103.938051  104.913596  102.019280
2021-09-12 09:39:00  104.480611  104.959785  104.454097
2021-09-12 09:40:00  104.017193  104.202852  103.956963
2021-09-12 09:41:00  103.551464  104.657799  101.088222
2021-09-12 09:42:00  103.793426  104.989633  103.601065
2021-09-12 09:43:00  101.880146  102.692672  101.578598
2021-09-12 09:44:00  100.155228  101.511468  100.120516
2021-09-12 09:45:00   99.592940   99.664950   98.424262
2021-09-12 09:46:00   98.580109   99.583642   97.437286
2021-09-12 09:47:00   98.894357   99.255993   98.142424
2021-09-12 09:48:00   97.986332   98.631452   97.195301
2021-09-12 09:49:00   96.574029   96.935424   95.664641
2021-09-12 09:50:00   98.039678   99.577714   96.636883
2021-09-12 09:51:00   97.813901   97.849727   96.412050
2021-09-12 09:52:00   97.881429   99.446073   97.294572
2021-09-12 09:53:00   96.456681   99.076426   94.266226
2021-09-12 09:54:00   95.912299   96.734201   94.921762
2021-09-12 09:55:00   96.023221   96.110268   95.456923
2021-09-12 09:56:00   94.872228   95.171235   94.772576
2021-09-12 09:57:00   95.247926   95.339686   94.744450
2021-09-12 09:58:00   94.647287   96.634856   93.096623
2021-09-12 09:59:00   94.355593   94.575265   94.287030
2021-09-12 10:00:00   93.753887   94.110999   92.691583
2021-09-12 10:01:00   95.606165   97.084059   95.132572
2021-09-12 10:02:00   95.592667   96.110938   94.673243
2021-09-12 10:03:00   94.534957   95.343450   92.985022
2021-09-12 10:04:00   95.357501   95.859258   94.574248
2021-09-12 10:05:00   94.136658   95.052060   93.814596
2021-09-12 10:06:00   94.345521   94.674273   93.532004
2021-09-12 10:07:00   92.385851   92.915611   91.154987
2021-09-12 10:08:00   91.057665   91.570933   90.830205
2021-09-12 10:09:00   91.254526   91.351604   89.947384
2021-09-12 10:10:00   91.992993   92.961638   90.385510
2021-09-12 10:11:00   92.164361   92.866414   91.979727
2021-09-12 10:12:00   92.048713   92.376375   91.788830
2021-09-12 10:13:00   91.747609   92.139717   90.965786
2021-09-12 10:14:00   90.269087   91.732602   89.032137
2021-09-12 10:15:00   89.549243   89.845363   88.228787
2021-09-12 10:16:00   89.088604   89.349660   88.566663
2021-09-12 10:17:00   90.145727   90.150840   89.848742
2021-09-12 10:18:00   90.489345   90.723932   90.238852
2021-09-12 10:19:00   88.726305   90.141675   88.379857
2021-09-12 10:20:00   89.050389   89.471034   88.370364
df_5mins=
                          price         ask         bid     ret_0  preds
2021-09-12 09:30:00  100.496714  100.881796  100.154000       NaN   -1.0
2021-09-12 09:35:00  102.060878  102.900095  101.886300  0.015564    1.0
2021-09-12 09:40:00  104.017193  104.202852  103.956963  0.019168    1.0
2021-09-12 09:45:00   99.592940   99.664950   98.424262 -0.042534    1.0
2021-09-12 09:50:00   98.039678   99.577714   96.636883 -0.015596   -1.0
2021-09-12 09:55:00   96.023221   96.110268   95.456923 -0.020568   -1.0
2021-09-12 10:00:00   93.753887   94.110999   92.691583 -0.023633   -1.0
2021-09-12 10:05:00   94.136658   95.052060   93.814596  0.004083    1.0
2021-09-12 10:10:00   91.992993   92.961638   90.385510 -0.022772    1.0
2021-09-12 10:15:00   89.549243   89.845363   88.228787 -0.026565    0.0
2021-09-12 10:20:00   89.050389   89.471034   88.370364 -0.005571    0.0
# tot_ret=-0.08611159905270441
After pnl simulation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth   pnl.sim
2021-09-12 09:30:00  100.496714  100.881796  100.154000       NaN   -1.0    0.979807 -1.916812  98.083188       NaN
2021-09-12 09:35:00  102.060878  102.900095  101.886300  0.015564    1.0    0.942952 -4.171857  93.911331 -0.042534
2021-09-12 09:40:00  104.017193  104.202852  103.956963  0.019168    1.0    0.942952 -1.464652  92.446679 -0.015596
2021-09-12 09:45:00   99.592940   99.664950   98.424262 -0.042534    1.0    0.942952 -1.901421  90.545258 -0.020568
2021-09-12 09:50:00   98.039678   99.577714   96.636883 -0.015596   -1.0    0.942952  2.139873  92.685131  0.023633
2021-09-12 09:55:00   96.023221   96.110268   95.456923 -0.020568   -1.0    0.988600 -0.378408  92.306723 -0.004083
2021-09-12 10:00:00   93.753887   94.110999   92.691583 -0.023633   -1.0    0.980561  2.101994  94.408717  0.022772
2021-09-12 10:05:00   94.136658   95.052060   93.814596  0.004083    1.0    1.026260 -2.507922  91.900794 -0.026565
2021-09-12 10:10:00   91.992993   92.961638   90.385510 -0.022772    1.0    1.026260 -0.511954  91.388840 -0.005571
2021-09-12 10:15:00   89.549243   89.845363   88.228787 -0.026565    0.0         NaN       NaN        NaN  0.000000
2021-09-12 10:20:00   89.050389   89.471034   88.370364 -0.005571    0.0         NaN       NaN        NaN  0.000000
After pnl lag computation: df_5mins=
                          price         ask         bid     ret_0  preds  num_shares      diff     wealth   pnl.sim   pnl.lag
2021-09-12 09:30:00  100.496714  100.881796  100.154000       NaN   -1.0    0.979807 -1.916812  98.083188       NaN -0.019168
2021-09-12 09:35:00  102.060878  102.900095  101.886300  0.015564    1.0    0.942952 -4.171857  93.911331 -0.042534 -0.042534
2021-09-12 09:40:00  104.017193  104.202852  103.956963  0.019168    1.0    0.942952 -1.464652  92.446679 -0.015596 -0.015596
2021-09-12 09:45:00   99.592940   99.664950   98.424262 -0.042534    1.0    0.942952 -1.901421  90.545258 -0.020568 -0.020568
2021-09-12 09:50:00   98.039678   99.577714   96.636883 -0.015596   -1.0    0.942952  2.139873  92.685131  0.023633  0.023633
2021-09-12 09:55:00   96.023221   96.110268   95.456923 -0.020568   -1.0    0.988600 -0.378408  92.306723 -0.004083 -0.004083
2021-09-12 10:00:00   93.753887   94.110999   92.691583 -0.023633   -1.0    0.980561  2.101994  94.408717  0.022772  0.022772
2021-09-12 10:05:00   94.136658   95.052060   93.814596  0.004083    1.0    1.026260 -2.507922  91.900794 -0.026565 -0.026565
2021-09-12 10:10:00   91.992993   92.961638   90.385510 -0.022772    1.0    1.026260 -0.511954  91.388840 -0.005571 -0.005571
2021-09-12 10:15:00   89.549243   89.845363   88.228787 -0.026565    0.0         NaN       NaN        NaN  0.000000       NaN
2021-09-12 10:20:00   89.050389   89.471034   88.370364 -0.005571    0.0         NaN       NaN        NaN  0.000000       NaN
# tot_ret_lag=-0.08611159905270405