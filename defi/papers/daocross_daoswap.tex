\documentclass[11pt, reqno]{amsart}
\newtheorem{theorem}{Theorem}
\usepackage{amsfonts, amssymb, amscd, amsrefs}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{slashed}
\usepackage{fullpage}

\newtheorem{thm}{Theorem}
\newtheorem{algorithm}[thm]{Algorithm}
\newtheorem{definition}[thm]{Definition}
\newtheorem{example}[thm]{Example}
\newtheorem{problem}[thm]{Problem}

\newcommand{\bidbtc}{\mathrm{bid}_\mathrm{BTC}}
\newcommand{\askbtc}{\mathrm{ask}_\mathrm{BTC}}
\newcommand{\bideth}{\mathrm{bid}_\mathrm{ETH}}
\newcommand{\asketh}{\mathrm{ask}_\mathrm{ETH}}

\newcommand{\bidbase}{\mathrm{bid}_\mathrm{quote\;token}}
\newcommand{\askbase}{\mathrm{ask}_\mathrm{quote\;token}}
\newcommand{\bidquote}{\mathrm{bid}_\mathrm{base\;token}}
\newcommand{\askquote}{\mathrm{ask}_\mathrm{base\;token}}
\newcommand{\BTC}{\mathrm{BTC}}
\newcommand{\ETH}{\mathrm{ETH}}
\newcommand{\DAI}{\mathrm{DAI}}
\newcommand{\USDC}{\mathrm{USDC}}
\newcommand{\USDT}{\mathrm{USDT}}
\newcommand{\midpoint}{\mathrm{midpoint}}

% Use this if using `\contrib[]{...}`.
%\makeatletter\let\@wraptoccontribs\wraptoccontribs\makeatother

\begin{document}

\title{DaoCross and DaoSwap}

\author{G.P. Saggese}
\author{Paul Smith}

\thanks{With contributions from Tamara Jordania, Samarth KaPatel, and Daniel Yachmenev}

\date{\today}

\maketitle

\tableofcontents


% ###############################################################################

\section{Introduction}
DaoCross and DaoSwap constitute a decentralized protocol that facilitates
on-chain ERC20 token exchange. DaoSwap provides a mechanism for efficient
relative price discovery, and DaoCross enables parties to engage in
zero market impact transactions with price improvement.

DaoSwap is a smart contract for performing decentralized Walrasian-style
auctions at regular time intervals. The auction performs price discovery by
matching supply and demand (\cite{Wa}).

DaoCross is a decentralized liquidity pool that crosses buy and sell orders
with respect to an external reference price, i.e., a price oracle. This allows
traders to interact directly with each other and share price improvement with
respect to exchanges (by trading at bid-ask midpoint). Additionally, order
intentions are not publicly disclosed prior to a cross, which enables block or
other high-volume traders to execute quickly with minimal market impact.

DaoSwap and DaoCross differ in how the token exchange rate is determined, but
both share several common advantages:
\begin{enumerate}
	\item Low Cost:
	      they are a DeFi primitive that allows trading tokens peer-to-peer
	      without incurring spread costs
	\item Capital Efficiency:
	      participants provide liquidity only when
	      they wish to trade, and only in the amount they wish to trade
	\item No Impermanent Loss:
	      liquidity providers are not exposed to the risk of impermanent loss
	      (a form of unrealized loss that becomes realized upon withdrawing
	      liquidity), unlike the case with other decentralized exchange protocols
	      based on automated market makers
	\item No Intermediary Custody:
	      exchanged tokens always remain under the control of their respective
	      owners
	\item No Rent Extraction from High-Frequency Traders:
	      speed alone does not confer an advantage to traders, as the discrete
	      timing prevents predatory tactics such as front-running, limit order
	      scalping, and spoofing, which are known issues seen with continuous
	      limit order books
	\item Ease-of-use: the interaction between buyers and sellers occurs
	      through smart contracts, with a website front-end available
\end{enumerate}

% ###############################################################################

\section{Matching liquidity}
Suppose there are two parties, Alice an ETH holder and Bob a BTC holder, who
wish to swap tokens at a competitive rate. Suppose also that there are many
additional ETH and BTC holders who may be interested in participating in a
swap. How should the liquidity be pooled? At first glance, it appears that
there should be a single pool of liquidity. The wrinkle manifests in determining
how to express a desire to trade. A simple expression of a desire to trade is
a limit order representing a commitment to trade up to $q$ in quantity of
a token at a token exchange rate up to $p$. But what if some parties express
quantity in terms ETH and and some in terms of BTC, and some parties express
limit prices in terms of ETH per BTC, while others express limit prices in
terms of BTC per ETH? Under these conditions, setting a single clearing price
and determining fill prioritization rules raises several questions. We will
raise and address these in the sequel, but to begin, we will consider a more
constrained setting.

\subsection{Breaking the symmetry}
To simplify, we follow the practice of FX (foreign exchange) futures markets,
which break the symmetry by specifying two non-interchangeable roles:
\begin{enumerate}
	\item a \emph{base} currency (for quantity)
	\item a \emph{quote} currency (for price)
\end{enumerate}
The roles are expressed by writing \emph{base currency/quote currency}, e.g.,
``EUR/USD".

A limit order then consists of a quantity expressed in the units of the base
currency and a price expressed in terms of the quote currency (per unit or
suitable multiple of base currency). See, for example, \cite{Cme23} (e.g.,
footnotes on page 25), for usage of this terminology. See \cite{CmeFx} for how
this works in practice for Euro FX contracts, where contract units are
denominated in Euros and price is quoted in U.S. dollars and cents per Euro
increment.

By breaking the symmetry, one may run a standard limit order book, hold a
classical Walrasian-style auction, and handle size quantization effects by
using one of a variety of priority rules based on quantity, price, and time.

See \cite{BeLaLiVa22} for discussion around these variations and their effects
on market quality outcomes.

On the other hand, liquidity for a pair of currencies may be split across two
separate contracts, necessarily with two separate limit order books. Using our
example, this would mean treating BTC/ETH and ETH/BTC as separate token pairs,
even though the union of the underlying parties and sources of liquidity are
the same.

\subsection{Basket case}
It seems plausible that by retaining the symmetry in the two-token case and
instead treating a pair of tokens as a single source of liquidity, one may
contrive a more efficient exchange mechanism.

This minor expansion, however, suggests widening even further the universe of
eligible swaps. For example, if there are three tokens available for exchange,
one could contemplate many-for-one, one-for-many, or many-for-many token swaps,
all to be carried out in an atomic fashion, and perhaps with complex
constraints. A toy case along these lines one may consider is as follows:
\begin{problem}[Triangular liquidity]
Suppose there are the following three parties:
\begin{itemize}
	\item Party A, who holds $\BTC$ and wants $\ETH$
	\item Party B, who holds $\ETH$ and wants $\DAI$
	\item Party C, who holds $\DAI$ and wants $\BTC$
\end{itemize}
How should an auction be structured to ``best" facilitate exchange?
\end{problem}
While there may be other use cases and even demand for such auctions,
unfortunately, the problem in general is NP-complete (e.g., \cite{XiStWh05}),
which is a significant limiting factor in terms of feasibility and
auction expense.

% ###############################################################################

\section{Protocol Introduction}
In the previous section, we discussed the notions of base currency and
quote currency from foreign exchange. Here we extend them to tokens.

\subsection{Base/quote tokens}
A token (ordered) pair consists of a \emph{base token} and a
\emph{quote token}. The shorthand notation for expressing the pair is
\emph{base token/quote token} (e.g., ``$\BTC/\ETH$"), and as such indicates the
respective roles of the tokens.

By convention, \emph{quantity} to exchange is expressed in terms of the base
token, and \emph{price} is a token exchange rate expressed in terms of the
quote token per unit of base token (or multiple thereof).

\subsubsection{Example of base/quote tokens}
By way of example, in the pair BTC/ETH, BTC is the base token and ETH is the
quote token. Interest to trade is expressed in terms of orders with BTC as
base token and ETH as quote token:
\begin{itemize}
	\item A ``buy" order represents a commitment to purchase the base token
	      (``BTC") and pay with the quote token (``ETH")
	\item A ``sell" order represents a commitment to sell the base token
	      (``BTC") and receive the quote token (``ETH").
	\item Quantity $q$ is in terms of the base token (``buy/sell a certain
	      amount of BTC")
	\item Limit price is in terms of the quote token (``buy/sell BTC with a
	      limit price of $p$ ETH per BTC")
\end{itemize}

A party who places a ``buy" order must have the quote token (``ETH") in custody,
i.e., in its wallet. A party who places a ``sell" order must have the base
token (``BTC") in custody.

\subsection{Order attributes}
A DaoCross or DaoSwap order must have the following attributes:
\begin{enumerate}
	\item Base token
	\item Quote token
	\item Action (buy/sell)
	\item Quantity
	\item Limit price
	\item Timestamp
	\item Deposit address
\end{enumerate}
We have discussed attributes 1-5 in some detail.

Timestamp is used to determine eligibility in a swap or cross and can play a
role in order fill priority.

Deposit address enables one to use multiple wallets to facilitate account
management. For example, a miner may have a supply of BTC collected and held in
one wallet which it would like to systematically diversify into ETH and perhaps
other tokens. In specifying a deposit address, it may use a separate wallet to
collect incoming ETH. This functionality is also standard in traditional
finance, e.g., purchasing T-Bills on TreasuryDirect.

\subsubsection{Order notation}
A general limit order is then represented by the tuple:
\begin{center}
	\texttt{(timestamp, action, quantity, base\_token, limit\_price, quote\_token, 
     deposit\_address)}
\end{center}

We organize the quantities involved in an order in a way that makes it simple
to read the constraints in natural language: ``At timestamp \texttt{timestamp}
create an order to \texttt{action} a \texttt{quantity} of the token
\texttt{base\_token} for a limit price of \texttt{limit\_price} with respect to
token \texttt{quote\_token} and deposit the resulting tokens at
\texttt{deposit\_address}"

For brevity's sake in the following we might:
\begin{itemize}
	\item omit the timestamp and the deposit address when not relevant
	\item omit the (infinite) limit price for market orders
\end{itemize}

\subsubsection{Example of limit order notation}
E.g., an order like:
\begin{center}
	\texttt{(1678660406, buy, 3.2, ETH, 4.0, wBTC, \texttt{0xdeadc0de})}
\end{center}
corresponds to the natural language description:
``At the timestamp Mon Mar 13 2023 02:33:25 GMT+0000, the user wants to buy 3.2
units of ETH, exchanging them for wBTC with a limit price of 4.0 wBTC per unit
of ETH, depositing the proceeds at \texttt{0xdeadc0de}".

wBTC is wrapped BTC, i.e., a token on the Ethereum blockchain tracking Bitcoin.

\subsubsection{Example of market order notation}
Consider a swap for the tokens ETH, wBTC and assume that:
\begin{itemize}
\item the exchange rate between ETH and wBTC is 0.2 (i.e., 5 ETH can be
  exchanged for 1 wBTC and vice versa)
\item there is no constraint on the quantity of ETH and wBTC available for each
  trade participants
\end{itemize}

Then
\begin{itemize}
    \item An order \texttt{(buy, 1.0, ETH, nan, wBTC)} means buying 1 ETH in
      exchange for 0.2 wBTC
    \item An order \texttt{(sell, 1.0, ETH, wBTC)} means selling 1 ETH,
      receiving the corresponding amount of 0.2 wBTC
    \item An order \texttt{(buy, 1.0, wBTC, ETH)} means buying 1 wBTC, paying
      with 5 ETH
    \item An order \texttt{(sell, 1.0, wBTC, ETH)} means exchanging 1 wBTC with
      5 ETH
\end{itemize}

\subsubsection{Example of limit orders}
Consider the same swap for ETH and wBTC above, assume the same exchange rate
of ETH and wBTC, i.e., $\frac{p_{ETH}}{p_{wBTC}} = 0.2$, assume that each agent
has a very large amount of ETH and wBTC.

A limit order \texttt{(buy, 1.0, ETH, 2.0, wBTC)} means ``buy 1 ETH paying in wBTC
assuming that the price of 1 ETH is at most 2 wBTC". In this case, since the
price of one ETH is equal to 0.2 wBTC, the exchange can be executed with
another party.

On the other hand, a limit order \texttt{(buy, 1.0, ETH, 0.1, wBTC)} requires
that the price of ETH be lower than the current price and this does not allow
the token swap to be carried out.

A limit order \texttt{(sell, 1.0, ETH, 2.0, wBTC)} means ``sell 1 unit of ETH,
receiving wBTC as long as the price of one unit of ETH is more than 2 wBTC".
Because $p_{ETH} = 0.2 \cdot p_{wBTC} < 2.0 \cdot p_{wBTC}$, the order can be
executed.

\subsubsection{Limit order as a set of linear inequalities}
Any limit order as defined above can be translated into inequalities involving
quantity of exchanged tokens and allowed token prices. These equations can then
be collected in a system of equations governing the equilibrium achieved by the
orders.

We indicate with an asterisk the quantities resulting from an executed swap
order:
\begin{itemize}
  \item $q_{base}^*(o_i)$ the actual quantity of the base token exchanged in
    the swap requested by order $o_i$
  \item $p_{base}^*(o_i)$ the actual price of the base token exchanged as per
    $o_i$
  \item Same definitions hold for the quote token $q_{quote}^*$ and $p_{quote}^*$
\end{itemize}

An order like $o_1 =$ \texttt{(buy, 2, A, 3, B)} means ``buy 2 units of token A
paying with token B with a limit price for A of at most 3 B" and it corresponds to a
set of inequalities on the actual quantity of A obtained and the price paid:
\begin{equation}
  \begin{cases}
    p_{base}^*(o_1) = p_A \le 3 p_B \\
    (0 \le q_{A}^*(o_1) \le 2) \land (p_A \le 3 p_B) \lor (q_A^*(o_1) = 0)\\
  \end{cases}
\end{equation}
The constraint on the quantity exchanged is conditioned to the corresponding
price satisfying the desired limit price constraint, otherwise the swap can not
be carried out and the exchanged quantity is 0.

While the constraint on quantities is specific of each order, the constraint on
price of base / quote token is a global one on the price of the corresponding
token since the price of a token needs to be the same across all the swaps.

In the same way, an order like $o_2 =$ \texttt{(sell, 3, A, 2, B)} means ``sell
3 units of token A paying in token B with a limit price for one unit of A of at
least 2 B" which corresponds to the inequialities
\begin{equation}
  \begin{cases}
    p_A \ge 2 p_B \\
    (0 \le q_{A}^*(o_2) \le 3) \land (p_A \ge 2 p_B) \lor (q_A^*(o_2) = 0)\\
  \end{cases}
\end{equation}

\subsubsection{Market order as a set of linear inequalities}
A market order (i.e., without a limit order) has no constraint on price and thus
it is reduced to:
\begin{equation}
  \begin{cases}
    p_A \le 3 p_B \\
    0 \le q_{A}^*(o_1) \le 2 \\
  \end{cases}
\end{equation}

\subsubsection{Order equivalence}
If the exchange rate between two tokens A and B is known and equal to
$p_A / p_B = c$, the four types of orders corresponding to "buying" vs "selling"
and to ``A for B" vs ``B for A" can be reduced to only two types since a buy
(sell) order for token A is equivalent to a sell (buy) order for token
B after properly converting the quantities and the limit price given the value
$c$.

This is easily shown in terms of the corresponding inequations describing the orders:

%p_A / p_B = c <-> q_A = c * q_B <-> q_A units of A can be exchanged with (const * q_B) units of B
%E.g., ETH / wBTC = 0.5 <-> 1 ETH = 0.5 wBTC <-> 2 ETH = 1 wBTC
%So 3 ETH can be exchanged with 1.5 wBTC
%
%q^*(o_1) = (buy, q_A, A, lp_B, B) = "buy at most q_A units of A, where the price for A is at most lp_B"
%q^*(o_1) <= q_A
%p_A / p_B <= lp_B
%
%(sell, q_B, B, lp_A, A) = "sell at most q_B units of B, where the price for B is at least lp_A"
%q^*(o_2) <= q_B
%p_B / p_A >= lp_A
%
%Since p_A / p_B <= lp_B <-> p_B / p_A >= 1 / lp_B and q_A = c * q_B, the first order o_2 = (sell, q_B, B, lp_A, A) is equivalent to (buy, c * q_B, A, 1 / lp_B, B).

\subsubsection{Example of order equivalence}
%Example of order equivalence. Assume that Alice wants to buy 5 wBTC with ETH. The exchange rate ETH / wBTC is 0.1 (or equivalently 1 ETH corresponds to 10 wBTC). With her order, Alice wants to receive 5 wBTC in exchange for 0.5 ETH. Alice would be satisfied also with an order of selling 0.5 ETH against wBTC. 
%
%q_BTC < 4
%p_ETH / p_BTC < 3
%
%q_BTC = 0 if (p_ETH / p_BTC >= 3) else q_BTC < 4

% ###############################################################################

\subsection{DaoCross reference price}
DaoCross relies on a \emph{price oracle} for determining the effective
token exchange rate in a cross. The price oracle may come from a lit
exchange, centralized or decentralized, or even on-chain automated market
makers such as Uniswap (\cite[\S 2.2]{AdZiRo20}).

The case of using an automated market maker as a price oracle is relatively
straightforward, provided there is an automated market maker trading the
target currency pair with sufficient liquidity.

To use an exchange as a price reference, we must consider some additional
steps. First, exchanges typically use a dollar stablecoin (e.g., USDC, USDT) as
the quote currency and all other currencies as base currencies. Our example
of BTC/ETH would be considered a cross pair in the world of traditional
finance. Because most cross pairs are not traded directly on exchanges, we
must derive a clearing price from pairs involving stablecoins.

\subsection{Lit exchange bid-ask midpoint reference price}
Let $\bidbtc, \askbtc$ be stablecoin-denominated top-of-book bid-ask prices
for $\BTC$ (e.g., expressed in $\USDC$), and $\bideth, \asketh$ be the analogous
prices for $\ETH$. Then, a commitment to buy one $\BTC$ and pay $\ETH$ would
clear at a midpoint price of
\[
	\BTC/\ETH_{\midpoint} = \frac{\bidbtc + \askbtc}{\bideth + \asketh}
\]
expressed in BTC per ETH. Note that if the dollar price of BTH is significantly
more than the dollar price of ETH, then this price implies paying many
multiples of ETH for BTC (as is the case at the time of this writing).

In general, DaoCross may use the following reference price for a base/quote
token pair, where the bids and asks come from a lit exchange and are expressed
in terms of stablecoin prices:
\begin{equation}
	\frac{\bidbase + \askbase}{\bidquote + \askquote}
\end{equation}

When using either an on-chain price oracle or an exchange as a price oracle,
it is possible to perform a time or volume weighted average of prices so as
to avoid extreme price variations and to mitigate the risk and effects of any
market manipulation attemps.

\subsubsection{Formulation of the general DaoSwap problem}
The general problem of determining the token equilibrium price and the
allocation among the swap participants can be formulated in terms of the
inequalities on quantities and prices corresponding to the orders and on the
need that the total quantity exchanged of each token is preserved across the
swaps, i.e., the quantity bought for each token is equal to the sold quantity.

Consider a set of limit orders in the form
$$o_i = (a, q_{base}, lp_{base}, q_{quote} = (a(o_i), q_{base}(o_i), lp_{base}(o_i), q_{quote}(o_i))$$

We encode the direction of the inequality on the price in a function:
$$
\mathit{to\_ineq}(a) =
\begin{cases}
  +1 \text{ for } a = \text{buy} \\
  -1 \text{ for } a = \text{sell} \\
\end{cases}
$$

Assume by convention that a buy order removes base tokens from the system and
provides quote tokens to the system, whereas a sell order does the opposite.

The sign of the contribution of base tokens by an order is encoded in

$$
\mathit{to\_diff}(a) = \mathit{diff}_{base} = -\mathit{diff}_{quote} =
\begin{cases}
  +1 \text{ for } a = \text{buy} \\
  -1 \text{ for } a = \text{sell} \\
\end{cases}
$$

E.g., if $o_i$ is a buy order and it is executed in its entirety, then $o_i$ takes
away from the system
$q^*_{base}(o_i)$ tokens of type $\mathit{to\_token}(q_{base}(o_i))$
and provides
$q^*_{quote}(o_i) = q^*_{base}(o_i) \cdot \frac{p^*_{quote}}{p^*_{base}}$
tokens of type $\mathit{to\_token}(q_{quote}(o_i))$.

Note that we could have express $\mathit{to\_ineq}(a)$ in terms of
$\mathit{to\_diff}(a)$ but we keep these two auxiliary variable separated for
sake of simplicity.

Each order imposes the constraint:

\begin{equation}
  \begin{cases}
    cond_i: \mathit{to\_ineq}(a(o_i))(p_{base}(o_i) \leq lp_{base}(o_i) p_{quote}(o_i)) \\
    (0 \le q^*_{base}(o_i) \le q_{base}) \land cond_i \lor (q^*_{base}(o_i) = 0) \\
    exch\_q_{base}(o_i) = \mathit{to\_diff}(a(o_i)) \cdot q_{base}(o_i)
    exch\_q_{quote}(o_i) = - \mathit{to\_diff}(a(o_i)) \cdot q_{base}(o_i) \cdot \frac{p_{quote}}{p_{base}}
  \end{cases}
\end{equation}

Rewriting all the constraints in terms of orders and the unique set of base and quote tokens:
$\mathit{to\_token}(q_{base}(o_i)) = t_1, ..., t_n$
\begin{equation}
  \begin{cases}
    \forall \text{ order } i cond_i: \mathit{to\_ineq}(a(o_i))(p^*_{base}(o_i) \leq lp_{base}(o_i) p^*_{quote}(o_i)) \\
    \forall \text{ order } i (0 \le q^*_{base}(o_i) \le q_{base}) \land (cond_i) \lor (q^*_{base}(o_i) = 0) \\
    \forall \text{ order} i exch\_q_{base}(o_i) = \mathit{to\_diff}(a(o_i)) \cdot q_{base}(o_i) \\
    \forall \text{ order} i exch\_q_{quote}(o_i) = - \mathit{to\_diff}(a(o_i)) \cdot q_{base}(o_i) \cdot \frac{p_{quote}}{p_{base}} \\
    \sum_{t_j} exch\_q_{base}(t_j) = 0 \\
    \sum_{t_k} exch\_q_{quote}(t_k) = 0 \\
  \end{cases}
\end{equation}

TODO(gp): Check the math better by implementing it. Also try to simplify the
formulation which is still cumbersome.

\subsubsection{Solution of the general DaoSwap problem}

The general solution of the DaoSwap problem is a set of non-linear equation with 
combinatorial constraints, which is of course NP-complete.

It can still be solved in an effective way with solvers like ...

TODO(gp): explain better, cite

\subsubsection{Formulating DaoCross problem}
In the DaoCross set-up, the price of the tokens involved into the swap is
determined by an external oracle.
This allows to simplify the general problem by applying the equivalence
principle between orders and removing the non-linearity from the set of
inequalities above.

In fact the actual prices $p^*$ compared to the limit price verifies or not the
boolean condition $cond_i$ which then allows to specify the quantity
constraints:
\begin{equation}
  \begin{cases}
    cond_i := \mathit{to\_ineq}(a(o_i))(p_{base}(o_i) \leq lp_{base}(o_i) p_{quote}(o_i)) \\
    0 \le q_{base}(o_i) \le q_{base} \text{ if } cond_i \\
    q_{base}(o_i) = 0 \text{ if } \lnot cond_i \\
  \end{cases}
\end{equation}

The problem then becomes a set of linear inequalities that can be solved with
several efficient methods (e.g., simplex-method).

TODO(gp): check

% ###############################################################################

\subsection{Order crossing}
At regular time intervals, order submissions are cut off and reference prices
are determined. An element of randomness is used to determine order cutoff
times and reference price cutoff times in order to
mitigate manipulative behaviors.

An order is eligible for matching if its timestamp is within the cutoff window
and if the external reference price does not exceed its limit price.

Except on occasions where eligible buy/sell volume is perfectly matched, not
all orders can be fully crossed. There are also discretization effects to
consider arising from discrete order sizes and a discrete price grid
\cite{BoBoDoGo18}[\S 3.2.1].
See \cite{BeLaLiVa22} for a discussion of the trade-offs surrounding
different prioritization rule choices. See \cite{MsAts} for the
prioritization rules used by one of Morgan Stanley's equity liquidity pools.

\subsubsection{Priority rules}
DaoCross prioritizes fills according to:
\begin{itemize}
	\item Volume (higher volume comes first in priority)
	\item Price (higher limit price breaks volume ties)
	\item Timestamp (earlier timestamp breaks ties in volume and price)
\end{itemize}
If, in the unlikely scenario that all three of these parameters perfectly
agree, a certain priority is not guaranteed.

\subsubsection{Matching algorithm}
The mechanism for matching eligible buy and sell orders consists of two
priority queues, one for eligible buy orders and one for eligible sell orders.
Priority is determined according to the volume/price/timestamp priority rules
introduced above. Top-of-queue orders are compared, and the lesser of the two
volumes is fully filled. Once an order is fully filled at the established
reference price. One an order is fully filled, it is removed from the priority
queue. The procedure continues until one of the two priority queues is empty.

\subsubsection{Computational complexity}
Let $n$ denote the sum (or max) of the number of eligible buy and sell orders.
Priority queue construction occurs in $O(n)$ time, order removal costs
$O(n \log n)$, and order remove occurs $O(n)$ times. So, the computational
time complexity of the task is $O(n \log n)$. Memory requirements are $O(n)$.

\subsubsection{DaoSwap variant}
The mechanics for DaoSwap are similar to those above, with the primary
difference being that an auction is used to determine a single clearing price.
Variations in prioritization rules also possible.

% ###############################################################################

\subsection{Fees}

% ###############################################################################

\subsection{Comparison with Uniswap}

Uniswap doesn't support limit orders
- v3 introduced some steps towards incorporating 
- DaoSwap/Cross supports limit orders

Because liquidity providers and liquidity takers are in general different users
operating at different time scales, Uniswap is affected by impermanent loss
- DaoSwap/Cross is not affected by that

Uniswap requires multiple swaps and fees for arbitrary tokens
- DaoSwap/Cross pools all the liquidity in a single optimization problem

% ###############################################################################
\section{Example}

% ###############################################################################

\bibliography{Daobib}
\bibliographystyle{amsplain}

\begin{thebibliography}{10}

	\bib{Ad18}{article}{
		author={Adams, Hayden},
		title={Uniswap Whitepaper},
		date={2018},
	}

	\bib{AdZiRo20}{article}{
		author={Adams, Hayden},
		author={Zinsmeister, Noah},
		author={Robinson, Dan},
		title={Uniswap v2 Core},
		date={March 2020},
		eprint={https://uniswap.org/whitepaper.pdf},
	}

	\bib{AdZiSaKeRo21}{article}{
		author={Adams, Hayden},
		author={Zinsmeister, Noah},
		author={Salem, Moody},
		author={Keefer, River},
		author={Robinson, Dan},
		title={Uniswap v3 Core},
		date={March 2021},
		eprint={https://uniswap.org/whitepaper-v3.pdf},
	}

	\bib{BeLaLiVa22}{article}{
		author={Bernales, Alejandro},
		author={Ladley, Daniel},
		author={Litos, Evangelos},
		author={Valenzuela, Marcela},
		title={Alternative Execution Priority Rules in Dark Pools},
		date={July 22, 2022},
		eprint={https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4169352},
	}

	\bib{BoBoDoGo18}{article}{
		author={Bouchaud, Jean-Philippe},
		author={Bonart, Julius},
		author={Donier, Jonathan},
		author={Gould, Martin},
		title={Trades, Quotes and Prices},
		date={2018},
	}

	\bib{Cme23}{article}{
		author={CME Group},
		title={2023 FX Product Guide},
		edition={22nd},
		eprint={https://www.cmegroup.com/trading/fx/files/fx-product-guide-2023-us.pdf},
	}

	\bib{CmeFx}{article}{
		author={CME Group},
		title={Euro FX Futures - Contract Specs},
		eprint={https://www.cmegroup.com/markets/fx/g10/euro-fx.contractSpecs.html},
	}

	\bib{Ha03}{article}{
		author={Hanson, Robin},
		title={Combinatorial Information Market Design},
		journal={Information Systems Frontiers},
		date={2003},
		volume={5},
		pages={107-119},
		eprint={https://doi.org/10.1023/A:1022058209073},
	}

	\bib{Ms}{article}{
		author={Morgan Stanley},
		title={Morgan Stanley Dark Pools},
		eprint={https://www.morganstanley.com/disclosures/morgan-stanley-dark-pools},
	}

	\bib{MsAts}{article}{
		author={Morgan Stanley},
		title={MS Pool ATS-N Filings},
		eprint={https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&filenum=013-00117&owner=exclude&count=40}
	}

	\bib{Wa}{article}{
		title={Walrasian auction},
		eprint={https://en.wikipedia.org/wiki/Walrasian_auction},
	}

	\bib{XiStWh05}{article}{
		author={Xia, Mu},
		author={Stallaert, Jan},
		author={Whinston, Andrew B.},
		title={Solving the combinatorial double auction problem},
		journal={Journal of Operation Research},
		date={2005},
		pages={239-251},
		volume={164},
		eprint={https://www.sciencedirect.com/science/article/abs/pii/S0377221703008981?via\%3Dihub},
	}

\end{thebibliography}

\end{document}
