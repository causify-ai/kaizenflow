\documentclass[11pt, reqno]{amsart}
\usepackage{amsfonts, amssymb, amscd, amsrefs}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{slashed}
\usepackage{fullpage}

% https://ctan.math.washington.edu/tex-archive/macros/latex/required/amscls/doc/amsthdoc.pdf
\theoremstyle{definition}
\newtheorem{defn}{Definition}
\newtheorem{problem}{Problem}
\theoremstyle{remark}
\newtheorem{exmp}{Example}

\newcommand{\bidbtc}{\mathrm{bid}_\mathrm{BTC}}
\newcommand{\askbtc}{\mathrm{ask}_\mathrm{BTC}}
\newcommand{\bideth}{\mathrm{bid}_\mathrm{ETH}}
\newcommand{\asketh}{\mathrm{ask}_\mathrm{ETH}}

\newcommand{\bidbase}{\mathrm{bid}_\mathrm{quote\;token}}
\newcommand{\askbase}{\mathrm{ask}_\mathrm{quote\;token}}
\newcommand{\bidquote}{\mathrm{bid}_\mathrm{base\;token}}
\newcommand{\askquote}{\mathrm{ask}_\mathrm{base\;token}}
% Use teletype for tokens (\texttt{...}), but do not allow italics
%  (\textnormal{...}).
\newcommand{\BTC}{\textnormal{\texttt{wBTC}}}
\newcommand{\ETH}{\textnormal{\texttt{ETH}}}
\newcommand{\DAI}{\textnormal{\texttt{DAI}}}
\newcommand{\USDC}{\textnormal{\texttt{USDC}}}
\newcommand{\USDT}{\textnormal{\texttt{USDT}}}
% Use non-italic teletype for order attributes in order notation.
\newcommand{\timestamp}{\textnormal{\texttt{timestamp}}}
\newcommand{\action}{\textnormal{\texttt{action}}}
\newcommand{\quantity}{\textnormal{\texttt{quantity}}}
\newcommand{\basetoken}{\textnormal{\texttt{base\_token}}}
\newcommand{\limitprice}{\textnormal{\texttt{limit\_price}}}
\newcommand{\quotetoken}{\textnormal{\texttt{quote\_token}}}
\newcommand{\depositaddress}{\textnormal{\texttt{deposit\_address}}}
%
\newcommand{\buy}{\textnormal{\texttt{buy}}}
\newcommand{\sell}{\textnormal{\texttt{sell}}}
\newcommand{\nan}{\textnormal{\texttt{nan}}}

\newcommand{\midpoint}{\mathrm{midpoint}}

% Use this if using `\contrib[]{...}`.
%\makeatletter\let\@wraptoccontribs\wraptoccontribs\makeatother

\begin{document}

\title{DaoCross and DaoSwap}

\author{G.P. Saggese}
\author{Paul Smith}

\thanks{With contributions from Tamara Jordania, Samarth KaPatel,
Grigorii Pomazkin, and Daniel Yachmenev}

\date{\today}

\maketitle

\tableofcontents


% ###############################################################################

\section{Introduction}
DaoCross and DaoSwap are smart
contracts\footnote{https://ethereum.org/en/developers/docs/smart-contracts/}
that facilitate on-chain
ERC-20\footnote{https://ethereum.org/en/developers/docs/standards/tokens/erc-20/}
token exchange. DaoSwap provides a mechanism for efficient relative price
discovery, and DaoCross enables parties to engage in zero market impact
transactions with price improvement.

DaoSwap performs price discovery by matching supply and demand at regular time
intervals. Supply and demand is expressed through a collection of buy and sell
limit orders, and the clearing price is determined by a Walrasian-style
auction (\cite{Wa}).

DaoCross is a decentralized liquidity pool that crosses buy and sell orders
with respect to an external reference price, i.e., a price oracle. This allows
traders to interact directly with each other and share price improvement with
respect to exchanges, e.g., by trading at bid-ask midpoint. Additionally, order
intentions are not publicly disclosed prior to a cross, which enables block or
other high-volume traders to execute quickly with minimal market impact.

DaoSwap and DaoCross differ in how the token exchange rate is determined, but
both share several common advantages:
\begin{enumerate}
	\item Low Cost:
	      they are a DeFi primitive that allows trading tokens peer-to-peer
	      without incurring spread costs
	\item Capital Efficiency:
	      participants provide liquidity only when
	      they wish to trade, and only in the amount they wish to trade
	\item No Impermanent Loss:
	      liquidity providers are not exposed to the risk of impermanent loss
	      (a form of unrealized loss that becomes realized upon withdrawing
	      liquidity), unlike the case with other decentralized exchange protocols
	      based on automated market makers
	\item No Intermediary Custody:
	      exchanged tokens always remain under the control of their respective
	      owners
	\item No Rent Extraction from High-Frequency Traders:
	      speed alone does not confer an advantage to traders, as the discrete
	      timing prevents predatory tactics such as front-running, limit order
	      scalping, and spoofing, which are known issues seen with continuous
	      limit order books
	\item Ease-of-use: the interaction between buyers and sellers occurs
	      through smart contracts, with a website front-end available
\end{enumerate}

% ###############################################################################

\section{Matching liquidity}
Suppose there are two parties, Alice an $\ETH$ holder and Bob a $\BTC$ holder
(wrapped bitcoin, an ERC-20 compliant coin that tracks bitcoin), who wish to =
swap tokens at a competitive rate. Suppose also that there are many
additional $\ETH$ and $\BTC$ holders who may be interested in participating in a
swap. How should the liquidity be pooled? At first glance, it appears that
there should be a single pool of liquidity. The wrinkle manifests in determining
how to express a desire to trade. A simple expression of a desire to trade is
a limit order representing a commitment to trade up to $q$ in quantity of
a token at a token exchange rate up to $p$. But what if some parties express
quantity in terms $\ETH$ and and some in terms of $\BTC$, and some parties
express limit prices in terms of $\ETH$ per $\BTC$, while others express limit
prices in terms of $\BTC$ per $\ETH$? Under these conditions, setting a single
clearing price and determining fill prioritization rules raises several
questions. We will consider and address these in the sequel, but to begin, we
will discuss a more constrained setting.

\subsection{Breaking the symmetry}
To simplify, we follow the practice of FX (foreign exchange) futures markets,
which break the symmetry by specifying two non-interchangeable roles:
\begin{enumerate}
	\item a \emph{base} currency (for quantity)
	\item a \emph{quote} currency (for price)
\end{enumerate}
The roles are expressed by writing \emph{base currency/quote currency}, e.g.,
``EUR/USD".

A limit order then consists of a quantity expressed in the units of the base
currency and a price expressed in terms of the quote currency (per unit or
suitable multiple of base currency). See, for example, \cite{Cme23} (e.g.,
footnotes on page 25) for usage of this terminology. See \cite{CmeFx} for how
this works in practice for Euro FX contracts, where contract units are
denominated in Euros and price is quoted in U.S. dollars and cents per Euro
increment.

By breaking the symmetry, one may run a standard limit order book, hold a
classical Walrasian-style auction, and handle size quantization effects by
using one of a variety of priority rules based on quantity, price, and time.
See \cite{BeLaLiVa22} for discussion around priority rule variations and their
effects on market quality outcomes.

An effect of breaking the symmetry in this way is that either liquidity for a
pair of currencies may be expressed in only one form, or liquidity for a pair
of currencies is split across two separate contracts (with roles of base and
quote token reversed), each with its own limit order book.
Using our example, this would mean treating $\BTC/\ETH$ and $\ETH/\BTC$ as
separate token pairs, even though the union of the underlying parties and
sources of liquidity are the same.

\subsection{Basket case}
It seems plausible that by retaining the symmetry in the two-token case and
instead treating a pair of tokens as a single source of liquidity, one may
contrive a more efficient exchange mechanism.

This minor expansion, however, suggests widening even further the universe of
eligible swaps. For example, if there are three tokens available for exchange,
one could contemplate many-for-one, one-for-many, or many-for-many token swaps,
all to be carried out in an atomic fashion, and perhaps with complex
constraints. A toy case along these lines one may consider is as follows:
\begin{problem}[Triangular liquidity]
Suppose there are the following three parties:
\begin{itemize}
	\item Party A, who holds $\BTC$ and wants $\ETH$
	\item Party B, who holds $\ETH$ and wants $\DAI$
	\item Party C, who holds $\DAI$ and wants $\BTC$
\end{itemize}
How should an auction be structured to ``best" facilitate exchange?
\end{problem}
While there may be other use cases and even demand for such auctions,
unfortunately, the problem in general is NP-complete (e.g., \cite{XiStWh05}),
which is a significant limiting factor in terms of feasibility and
auction expense.

% ###############################################################################

\section{Protocol introduction}
In the previous section, we discussed the notions of base currency and
quote currency from foreign exchange. Here we extend them to tokens.

\subsection{Base/quote tokens}
A token (ordered) pair consists of a \emph{base token} and a
\emph{quote token}. The shorthand notation for expressing the pair is
\emph{base token/quote token} (e.g., ``$\BTC/\ETH$"), and as such indicates the
respective roles of the tokens.

By convention, \emph{quantity} to exchange is expressed in terms of the base
token, and \emph{price} is a token exchange rate expressed in terms of the
quote token per unit of base token (or multiple thereof).

\begin{exmp}[base/quote tokens]
By way of example, in the pair $\BTC/\ETH$, $\BTC$ is the base token and $\ETH$
is the quote token. Interest to trade is expressed in terms of orders
with $\BTC$ as base token and $\ETH$ as quote token, as follows:
\begin{itemize}
	\item A ``buy" order represents a commitment to purchase the base token
        $\BTC$ and pay with the quote token $\ETH$
	\item A ``sell" order represents a commitment to sell the base token
	      $\BTC$) and receive the quote token $\ETH$.
	\item Quantity $q$ is in terms of the base token (``buy/sell a certain
	      amount of $\BTC$")
	\item Limit price is in terms of the quote token (``buy/sell $\BTC$ with a
	      limit price of $p$ $\ETH$ per $\BTC$")
\end{itemize}
A party who places a ``buy" order must have the quote token ($\ETH$) in custody,
i.e., in its wallet. A party who places a ``sell" order must have the base
token ($\BTC$) in custody.
\end{exmp}

\subsection{Order attributes and notation}
We introduce the following tuple notation for a general limit order
(valid for both DaoCross and DaoSwap).
\begin{defn}[Limit order]
A DaoCross or DaoSwap limit order is represented by a tuple of the form
\begin{align*}
    ( & \timestamp, \\
    & \action, \\
    & \quantity, \\
    & \basetoken, \\
    & \limitprice, \\
    & \quotetoken, \\
    & \depositaddress )
\end{align*}
\end{defn}

The quantities are arranged to make the order simple to read in natural
language:
``At timestamp $\timestamp$ create an order to $\action$ a $\quantity$ of
the token $\basetoken$ for a limit price of $\limitprice$ with respect to
the token $\quotetoken$ and deposit the resulting tokens at $\depositaddress$."

We have previously discussed the roles of \action, \quantity, \basetoken,
\limitprice, and \quotetoken.
The roles of $\timestamp$ include determining eligibility in a swap or
cross and can extend to influencing order fill priority.
The $\depositaddress$ attribute mirrors standard functionality
available in traditional finance, e.g., in purchasing T-Bills on
TreasuryDirect\footnote{https://www.treasurydirect.gov}. This feature
facilitates account management through the use of multiple wallets. For
example, a miner may have a supply of $\texttt{BTC}$ collected and held in one wallet
which it would like to systematically diversify into $\ETH$ and perhaps other
tokens. In specifying a deposit address, it may use a separate wallet to collect
incoming $\ETH$.

For brevity, in the sequel we may:
\begin{itemize}
	\item omit $\timestamp$ and $\depositaddress$ when not relevant to the
        discussion
	\item omit the (infinite) $\limitprice$ for market orders
\end{itemize}

\begin{exmp}[Limit order notation]
The order
\begin{center}
    (\textnormal{\texttt{1678660406}},
    \buy,
    \textnormal{\texttt{3.2}},
    \ETH,
    \textnormal{\texttt{4.0}},
    \BTC,
    \textnormal{\texttt{0xdeadc0de}})
\end{center}
corresponds to the natural language description:
``At timestamp \textnormal{\texttt{Mon Mar 13 2023 02:33:25 GMT+0000}}, the user
commits to $\buy$ up to \textnormal{\texttt{3.2}} units of $\ETH$ in exchange
for $\BTC$ up to a $\limitprice$ of \textnormal{\texttt{4.0}} $\BTC$ per $\ETH$
with proceeds deposited at \textnormal{\texttt{0xdeadc0de}}".
\end{exmp}

Next we introduce some examples of market order and limit order behavior when
a clearing rate has been set.
In particular, consider a swap for the tokens $\ETH$, $\BTC$ and assume that
the exchange rate between $\ETH$ and $\BTC$ is fixed at 0.2 (i.e.,
0.2 $\BTC$ can be exchanged for 1 $\ETH$ and vice versa).

\begin{exmp}[Market order notation and clearing]
The following market orders omit $\timestamp$, $\limitprice$, and
$\depositaddress$ in favor of emphasizing the amounts of tokens exchanged:
\begin{itemize}
    \item An order \texttt{(\buy, 1.0, $\ETH$, $\BTC$)} means buying 1
      $\ETH$ in exchange for 0.2 $\BTC$
    \item An order \texttt{(\sell, 1.0, $\ETH$, $\BTC$)} means selling 1 $\ETH$,
      receiving the corresponding amount of 0.2 $\BTC$
    \item An order \texttt{(\buy, 1.0, $\BTC$, $\ETH$)} means buying 1 $\BTC$,
      paying with 5 $\ETH$
    \item An order \texttt{(\sell, 1.0, $\BTC$, $\ETH$)} means exchanging
      1 $\BTC$ in return for 5 $\ETH$
\end{itemize}
\end{exmp}

Next we consider the behavior of limit orders under the same prevailing exchange
rate (and we assume that there is sufficient supply of tokens to fully fill the
orders).

\begin{exmp}[Executable buy limit order]
A limit order
\[
\texttt{(\buy, 1.0, $\ETH$, 0.5, $\BTC$)}
\]
means
``$\buy$ up to 1 $\ETH$ in exchange for $\BTC$ at a rate up to 0.5 $\BTC$ per $\ETH$."
In this case, since the price of one $\ETH$ is equal to 0.2 $\BTC$, the order
can be executed at the prevailing market rate.
\end{exmp}

\begin{exmp}[Non-executable buy limit order]
On the other hand, a limit order
\[
\texttt{(\buy, 1.0, $\ETH$, 0.1, $\BTC$)}
\]
requires that the rate of $\BTC$ per $\ETH$ be lower than the current market
rate, and so the limit price prevents a token swap from being carried out.
\end{exmp}

\begin{exmp}[Non-executable sell limit order]
A limit order
\[
\texttt{(\sell, 1.0, $\ETH$, 0.5, $\BTC$)}
\]
means
``\sell up to 1 unit of $\ETH$ in exchange for $\BTC$ at a rate down to 0.5 $\BTC$ per $\ETH$."
Since the current rate of $\BTC$ per $\ETH$ is 0.2, which is below the limit
price of 0.5, the order cannot be executed.
\end{exmp}

\subsection{Limit order as a set of linear inequalities}
Any limit order as defined above can be translated into inequalities involving
quantity of exchanged tokens and token exchange rates. Multiple limit orders
can be converted into a system of inequalities, which collectively constrain
potential exchange outcomes.

In both DaoCross and DaoSwap, a swap between a given base/quote token pair
occurs at a single exchange rate, i.e., the clearing price is the same for
all executed orders. On the other hand, quantity exchanged is specific to
each order and each order's constraint on quantity exchanged cannot be
violated.

In the sequel we use an asterisk to denote clearing quantity and exchange
rate:
\begin{itemize}
    \item $q_{base}^*(o_i)$ denotes quantity of the base token exchanged in a
      swap from order $o_i$
  \item $p_{quote\_per\_base}^*(o_i)$ denotes exchange rate at
  % \item Same definitions hold for the quote token $q_{quote}^*$ and $p_{quote}^*$
\end{itemize}
Note that
\[
    p_{quote\_per\_base}^*(o_i) =
    1 / p_{base\_per\_quote}^*(o_i)
\]

An order of the form $o_1 =$ \texttt{(\buy, 2, A, 3, B)} means ``buy 2 units of
token A in exchange for token B with a limit price up to 3 B per unit of A"
and it corresponds to the following constraint on realized quantity exchanged
and clearing exchange rate:
\begin{equation*}
    (p_{B\_per\_A}^*(o_1) \leq 3) \land
    (0 \le q_{A}^*(o_1) \leq 2) \lor
    (q_A^*(o_1) = 0)
\end{equation*}
The constraint on the quantity exchanged is conditioned on the corresponding
price satisfying the desired limit price constraint, otherwise the swap cannot
be carried out and the exchanged quantity is 0.

In the same way, an order like $o_2 =$ \texttt{(sell, 3, A, 2, B)} means ``sell
3 units of token A paying in token B with a limit price for one unit of A of at
least 2 B" which corresponds to
\begin{equation*}
    (p_{B\_per\_A}^*(o_2) \geq 2) \land
    (0 \le q_{A}^*(o_2) \leq 2) \lor
    (q_A^*(o_2) = 0)
\end{equation*}
A market order (i.e., without a limit price) has no constraint on exhange rate
and thus is reduced to
\[
    0 \le q_{A}^*(o_1) \le 2
\]

\subsubsection{Order equivalence}
Let
\[
    o_1 = (\buy, q, A, p_{B\_per\_A}, B).
\]
Suppose that $p^*_{B\_per\_A}$ is fixed and known. Then the order
\[
    o_2 = (\sell, q^\prime, B, 1 / p_{B\_per\_A}, A)
\]
may be handled in order crossing in the same way that $o_1$ may be
provided that
\[
    q^\prime = q \cdot p^*_{B\_per\_A}
\]

% TODO(gp): flesh out the examples
%p_A / p_B = c <-> q_A = c * q_B <-> q_A units of A can be exchanged with (const * q_B) units of B
%E.g., ETH / wBTC = 0.5 <-> 1 ETH = 0.5 wBTC <-> 2 ETH = 1 wBTC
%So 3 ETH can be exchanged with 1.5 wBTC
%
%q^*(o_1) = (buy, q_A, A, lp_B, B) = "buy at most q_A units of A, where the price for A is at most lp_B"
%q^*(o_1) <= q_A
%p_A / p_B <= lp_B
%
%(sell, q_B, B, lp_A, A) = "sell at most q_B units of B, where the price for B is at least lp_A"
%q^*(o_2) <= q_B
%p_B / p_A >= lp_A
%
%Since p_A / p_B <= lp_B <-> p_B / p_A >= 1 / lp_B and q_A = c * q_B, the first order o_2 = (sell, q_B, B, lp_A, A) is equivalent to (buy, c * q_B, A, 1 / lp_B, B).

% \subsubsection{Example of order equivalence}
%Example of order equivalence. Assume that Alice wants to buy 5 wBTC with ETH. The exchange rate ETH / wBTC is 0.1 (or equivalently 1 ETH corresponds to 10 wBTC). With her order, Alice wants to receive 5 wBTC in exchange for 0.5 ETH. Alice would be satisfied also with an order of selling 0.5 ETH against wBTC. 
%
%q_BTC < 4
%p_ETH / p_BTC < 3
%
%q_BTC = 0 if (p_ETH / p_BTC >= 3) else q_BTC < 4

% ###############################################################################

\section{Reference clearing prices and prioritization}
DaoCross relies on a \emph{price oracle} for determining the effective
token exchange rate in a cross. The price oracle may come from a lit
exchange, centralized or decentralized, or even on-chain automated market
makers such as Uniswap (\cite[\S 2.2]{AdZiRo20}).

The case of using an automated market maker as a price oracle is relatively
straightforward, provided there is an automated market maker trading the
target currency pair with sufficient liquidity.

To use an exchange as a price reference, we must consider some additional
steps. First, exchanges typically use a dollar stablecoin (e.g., USDC, USDT) as
the quote currency and all other currencies as base currencies. Our example
of BTC/ETH would be considered a cross pair in the world of traditional
finance. Because most cross pairs are not traded directly on exchanges, we
must derive a clearing price from pairs involving stablecoins.

\subsection{Lit exchange bid-ask midpoint reference price}
Let $\bidbtc, \askbtc$ be stablecoin-denominated top-of-book bid-ask prices
for $\BTC$ (e.g., expressed in $\USDC$), and $\bideth, \asketh$ be the analogous
prices for $\ETH$. Then, a commitment to buy one $\BTC$ and pay $\ETH$ would
clear at a midpoint price of
\[
	\BTC/\ETH_{\midpoint} = \frac{\bidbtc + \askbtc}{\bideth + \asketh}
\]
expressed in BTC per ETH. Note that if the dollar price of BTH is significantly
more than the dollar price of ETH, then this price implies paying many
multiples of ETH for BTC (as is the case at the time of this writing).

In general, DaoCross may use the following reference price for a base/quote
token pair, where the bids and asks come from a lit exchange and are expressed
in terms of stablecoin prices:
\begin{equation}
	\frac{\bidbase + \askbase}{\bidquote + \askquote}
\end{equation}

When using either an on-chain price oracle or an exchange as a price oracle,
it is possible to perform a time or volume weighted average of prices so as
to avoid extreme price variations and to mitigate the risk and effects of any
market manipulation attemps.

\subsection{Order crossing}
At regular time intervals, order submissions are cut off and reference prices
are determined. An element of randomness is used to determine order cutoff
times and reference price cutoff times in order to
mitigate manipulative behaviors.

An order is eligible for matching if its timestamp is within the cutoff window
and if the external reference price does not exceed its limit price.

Except on occasions where eligible buy/sell volume is perfectly matched, not
all orders can be fully crossed. There are also discretization effects to
consider arising from discrete order sizes and a discrete price grid
\cite{BoBoDoGo18}[\S 3.2.1].
See \cite{BeLaLiVa22} for a discussion of the trade-offs surrounding
different prioritization rule choices. See \cite{MsAts} for the
prioritization rules used by one of Morgan Stanley's equity liquidity pools.

\subsubsection{Priority rules}
DaoCross prioritizes fills according to:
\begin{itemize}
	\item Volume (higher volume comes first in priority)
	\item Price (higher limit price breaks volume ties)
	\item Timestamp (earlier timestamp breaks ties in volume and price)
\end{itemize}
If, in the unlikely scenario that all three of these parameters perfectly
agree, a certain priority is not guaranteed.

\subsubsection{Matching algorithm}
The mechanism for matching eligible buy and sell orders consists of two
priority queues, one for eligible buy orders and one for eligible sell orders.
Priority is determined according to the volume/price/timestamp priority rules
introduced above. Top-of-queue orders are compared, and the lesser of the two
volumes is fully filled. Once an order is fully filled at the established
reference price. One an order is fully filled, it is removed from the priority
queue. The procedure continues until one of the two priority queues is empty.

\subsubsection{Computational complexity}
Let $n$ denote the sum (or max) of the number of eligible buy and sell orders.
Priority queue construction occurs in $O(n)$ time, order removal costs
$O(n \log n)$, and order remove occurs $O(n)$ times. So, the computational
time complexity of the task is $O(n \log n)$. Memory requirements are $O(n)$.

\subsubsection{DaoSwap variant}
The mechanics for DaoSwap are similar to those above, with the primary
difference being that an auction is used to determine a single clearing price.
Variations in prioritization rules also possible.

% ###############################################################################

\section{Formulation of the general DaoSwap problem}
The general problem of determining the token equilibrium price and the
allocation among the swap participants can be formulated in terms of the
inequalities on quantities and prices corresponding to the orders and on the
need that the total quantity exchanged of each token be preserved across the
swaps, i.e., the quantity bought for each token is equal to the quantity sold.

\subsection{Limit order inequalities}
Let $\{o_i\}_{i = 1}^n$ be a set of limit orders, each of the form
\[
    o_i = (a_i, q_i, \basetoken_i, p_i, \quotetoken_i)
\]
where the quote token is implicit in the quantity $q_i$ and the quote and base
tokens are implicit in the limit price $p_i$.
To encode directionality in the limit price inequality, we introduce
\[
    \mathcal{I}(a) :=
    \begin{cases}
      +1 \text{ for } a = \buy \\
      -1 \text{ for } a = \sell \\
    \end{cases}
\]
For each $i$, define
\[
    c_i := \left(
    p^*_{\quotetoken_i\_per\_\basetoken_i} \leq \mathcal{I}(a_i) \cdot p_i
    \right)
\]
where $p^*_{\quotetoken_i\_per\_\basetoken_i}$ is the unique clearing price for
the indicated base token/quote token ordered pair.
TODO(Paul): revive the ``to token" notation.
Then, each limit order $o_i$ may be expressed as
\[
    c_i \land
    (q_i^* \leq q_i) \lor
    (q_i^* = 0)
\]

\subsection{No arbitrage}
Let $T$ denote the intersection of the union of all base tokens and the union
of all quote tokens:
\[
    T :=
    \left( \cup_i \basetoken_i \right)
    \cap
    \left( \cup_i \quotetoken_i \right)
\]
The set of tokens $T$ is the set of tokens eligible for swapping.
We require the following \emph{no arbitrage}
constraints be satisfied for all tokens $u, v, w \in T$
involved in a swap:
\[
    p^*_{u\_per\_v} \cdot
    p^*_{v\_per\_w} = 
    p^*_{u\_per\_w}
\]
Note that, in the case $w = u$, this enforces a unique exchange rate between
a pair of tokens (changing the roles of the base and quote tokens inverts the
exchange rate).

\subsection{Conservation of exchanged value}

For each order $i$, let $\tilde{q}_i^*$ denote the quantity of
$\quotetoken_i$ exchanged. Then we must have
\[
    \tilde{q}_i^* = q_i^* \cdot p_{\quotetoken_i\_per\_\basetoken_i}^*
\]
for each $i$. In effect, this enforces the market clearing price for each
order.

\subsection{Conservation of exchanged tokens}

Assume by convention that a buy order removes base tokens from the system and
provides quote tokens to the system, whereas a sell order does the opposite.

For each token $u \in T$, define the indicator function
$\mathcal{T}: T \to \{0, 1\}$ via
\[
    \mathcal{T}_u(v) =
    \begin{cases}
    1 \text{ if } v = u \\
    0 \text{ if } v \neq u
    \end{cases}
\]
Then, for each $u \in T$, the following conservation law must hold:
\[
    \sum_i \mathcal{T}_u(\basetoken_i) \cdot q^*_i
    =
    - \sum_i \mathcal{T}_u(\quotetoken_i) \cdot \tilde{q}_i^*
\]
Note that this translates into one equality per token participating in the
swap. Note also that this is a global constraint on the swap rather than local
to each order;
in particular, it expresses the notion that each filled order must have,
across the collection of orders, suitable counterparties.

\subsection{Combining the constraints}

We now collect the constraints that must be satisfied:
\begin{equation}
  \begin{cases}
    c_i \land (q_i^* \leq q_i) \lor (q_i^* = 0)
      & \forall i \in \{1, \ldots, n\} \\
    \tilde{q}_i^* = q_i^* \cdot p_{\quotetoken_i\_per\_\basetoken_i}^*
      & \forall i \in \{1, \ldots, n\} \\
    p^*_{u\_per\_v} \cdot p^*_{v\_per\_w} = p^*_{u\_per\_w}
      & \forall u, v, w \in T \\
    \sum_{j = 1}^n \mathcal{T}_u(\basetoken_j) \cdot q^*_j
    =
      - \sum_{j = 1}^n \mathcal{T}_u(\quotetoken_j) \cdot \tilde{q}_j^*
      & \forall u \in T
  \end{cases}
\end{equation}

\subsection{Solution of the general DaoSwap problem}

The general solution of the DaoSwap problem must satisfy a set of non-linear,
combinatorial constraints, whose solution is NP-complete.

It can still be solved in an effective way with solvers like ...

TODO(gp): explain better, cite

\subsection{Reformulating the DaoCross problem}
In the DaoCross set-up, the price of the tokens involved in the swap is
determined by an external oracle.
This allows simplifying the general problem by applying the equivalence
principle between orders and removing the non-linearity from the set of
inequalities above.

In fact, the actual prices $p^*$ compared to the limit price verifies or not the
boolean condition $c_i$, which then allows specifying the quantity
constraints:
\begin{equation}
  \begin{cases}
    cond_i := \mathit{to\_ineq}(a(o_i))(p_{base}(o_i) \leq lp_{base}(o_i) p_{quote}(o_i)) \\
    0 \le q_{base}(o_i) \le q_{base} \text{ if } cond_i \\
    q_{base}(o_i) = 0 \text{ if } \lnot cond_i \\
  \end{cases}
\end{equation}

The problem then becomes a set of linear inequalities that can be solved with
various efficient methods (e.g., simplex-method).

TODO(gp): check

% ###############################################################################

% \section{Fees}

% ###############################################################################

\section{Comparison with automated market makers}

Uniswap doesn't support limit orders
- v3 introduced some steps towards incorporating 
- DaoSwap/Cross supports limit orders

Because liquidity providers and liquidity takers are in general different users
operating at different time scales, Uniswap is affected by impermanent loss
- DaoSwap/Cross is not affected by that

Uniswap requires multiple swaps and fees for arbitrary tokens
- DaoSwap/Cross pools all the liquidity in a single optimization problem


% ###############################################################################

\bibliography{Daobib}
\bibliographystyle{amsplain}

\begin{thebibliography}{10}

	\bib{Ad18}{article}{
		author={Adams, Hayden},
		title={Uniswap Whitepaper},
		date={2018},
        eprint={https://hackmd.io/s/HJ9jLsfTz},
	}

	\bib{AdZiRo20}{article}{
		author={Adams, Hayden},
		author={Zinsmeister, Noah},
		author={Robinson, Dan},
		title={Uniswap v2 Core},
		date={March 2020},
		eprint={https://uniswap.org/whitepaper.pdf},
	}

	\bib{AdZiSaKeRo21}{article}{
		author={Adams, Hayden},
		author={Zinsmeister, Noah},
		author={Salem, Moody},
		author={Keefer, River},
		author={Robinson, Dan},
		title={Uniswap v3 Core},
		date={March 2021},
		eprint={https://uniswap.org/whitepaper-v3.pdf},
	}

	\bib{BeLaLiVa22}{article}{
		author={Bernales, Alejandro},
		author={Ladley, Daniel},
		author={Litos, Evangelos},
		author={Valenzuela, Marcela},
		title={Alternative Execution Priority Rules in Dark Pools},
		date={July 22, 2022},
		eprint={https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4169352},
	}

	\bib{BoBoDoGo18}{book}{
		author={Bouchaud, Jean-Philippe},
		author={Bonart, Julius},
		author={Donier, Jonathan},
		author={Gould, Martin},
		title={Trades, Quotes and Prices: Financial Markets Under the Microscope},
		date={2018},
        publisher={Cambridge University Press},
        doi={https://doi.org/10.1017/9781316659335},
	}

	\bib{Cme23}{article}{
		author={CME Group},
		title={2023 FX Product Guide},
		edition={22nd},
		eprint={https://www.cmegroup.com/trading/fx/files/fx-product-guide-2023-us.pdf},
	}

	\bib{CmeFx}{article}{
		author={CME Group},
		title={Euro FX Futures - Contract Specs},
		eprint={https://www.cmegroup.com/markets/fx/g10/euro-fx.contractSpecs.html},
	}

	\bib{Ha03}{article}{
		author={Hanson, Robin},
		title={Combinatorial Information Market Design},
		journal={Information Systems Frontiers},
		date={2003},
		volume={5},
		pages={107-119},
		eprint={https://doi.org/10.1023/A:1022058209073},
	}

    \bib{MiMoRoZh22}{article}{
        author={Milionis, Jason},
        author={Moallemi, Ciamac C.},
        author={Roughgarden, Tim},
        author={Zhang, Anthony Lee},
        title={Automated Market Making and Loss-Versus-Rebalancing},
        date={2022},
        eprint={https://doi.org/10.48550/arXiv.2208.06046},
    }

	\bib{Ms}{article}{
		author={Morgan Stanley},
		title={Morgan Stanley Dark Pools},
		eprint={https://www.morganstanley.com/disclosures/morgan-stanley-dark-pools},
	}

	\bib{MsAts}{article}{
		author={Morgan Stanley},
		title={MS Pool ATS-N Filings},
		eprint={https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&filenum=013-00117}
	}

	\bib{Wa}{article}{
		title={Walrasian auction},
		eprint={https://en.wikipedia.org/wiki/Walrasian_auction},
	}

	\bib{XiStWh05}{article}{
		author={Xia, Mu},
		author={Stallaert, Jan},
		author={Whinston, Andrew B.},
		title={Solving the combinatorial double auction problem},
		journal={Journal of Operation Research},
		date={2005},
		pages={239-251},
		volume={164},
		eprint={https://www.sciencedirect.com/science/article/abs/pii/S0377221703008981},
	}

\end{thebibliography}

\end{document}
