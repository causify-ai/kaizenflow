<!--ts-->
- [Structure of the logs folder](#structure-of-the-logs-folder)
- [Log directory Layout](#log-directory-layout)
- [balances](#balances)
- [bid\_ask](#bid_ask)
- [ccxt\_order\_responses](#ccxt_order_responses)
- [child\_order\_fills](#child_order_fills)
  - [ccxt\_fills](#ccxt_fills)
  - [ccxt\_trades](#ccxt_trades)
  - [oms\_fills](#oms_fills)
- [exchange\_markets](#exchange_markets)
- [leverage\_info](#leverage_info)
- [oms\_child\_orders](#oms_child_orders)
- [oms\_parent\_orders](#oms_parent_orders)
- [positions](#positions)
- [reduce\_only](#reduce_only)
  - [ccxt\_child\_order\_responses](#ccxt_child_order_responses)
  - [oms\_child\_orders](#oms_child_orders-1)



<!--te-->
This document contains the data schema for the CCXT Broker logs.

The log files are generated by `CcxtBroker` and read by `CcxtLogger` objects.

Last review: 2023-10-31.

# Structure of the logs folder

The expected structure of the logs folder is:
    ```
    {log_dir}/
        oms_parent_orders/
            - Initial input parent orders in the state before submission
        ccxt_child_order_responses/
        oms_child_orders/
        child_order_fills/
            ccxt_fills/
                - Information about closed orders from CCXT
            oms_fills/
                - JSON representations of `oms.Fill` objects generated by the
                  Broker
            ccxt_trades/
                - Output of CCXT `fetchMyTrades` method which contains the 'fees'
                  and 'realizedPNL' fields
    ```

# Log directory Layout

- Log_dir
  - balances
  - bid_ask
  - ccxt_child_order_responses
  - child_order_fills
    - ccxt_fills
    - ccxt_trades
    - oms_fills
  - exchange_markets
  - leverage_info
  - oms_child_orders
  - oms_parent_orders
  - positions
  - reduce_only
    - ccxt_child_order_responses
    - oms_child_orders

# balances

Loaded by `load_balances`

The balance log file has the [balance structure](https://docs.ccxt.com/#/README?id=balance-structure) generated by CCXT at the moment when latest balance is requested. It contains query for balance and has the amount of funds available for trading or funds locked in orders.

Schema:
```
{
    'info':  { ... },    // the original untouched non-parsed reply with details
    'timestamp': 1499280391811, // Unix Timestamp in milliseconds (seconds * 1000)
    'datetime': '2017-07-05T18:47:14.692Z', // ISO8601 datetime string with milliseconds

    //-------------------------------------------------------------------------
    // indexed by availability of funds first, then by currency

    'free':  {           // money, available for trading, by currency
        'BTC': 321.00,   // floats...
        'USD': 123.00,
        ...
    },

    'used':  { ... },    // money on hold, locked, frozen, or pending, by currency

    'total': { ... },    // total (free + used), by currency

    //-------------------------------------------------------------------------
    // indexed by currency first, then by availability of funds

    'BTC':   {           // string, three-letter currency code, uppercase
        'free': 321.00   // float, money available for trading
        'used': 234.00,  // float, money on hold, locked, frozen or pending
        'total': 555.00, // float, total balance (free + used)
    },

    'USD':   {           // ...
        'free': 123.00   // ...
        'used': 456.00,
        'total': 579.00,
    },

    ...
}
```       

# bid_ask

Loaded by `load_bid_ask_files`

Bid ask files are in CSV format, these contain the raw data logged directly from `RawDataReader` prior to any transformations.

Schema:
```
 #   Column                   Dtype
---  ------                   -----
 0   timestamp                int64
 1   currency_pair            object
 2   exchange_id              object
 3   end_download_timestamp   object
 4   knowledge_timestamp      object
 5   bid_size_l1              float64
 6   bid_price_l1             float64
 7   ask_size_l1              float64
 8   ask_price_l1             float64
``` 

# ccxt_order_responses

Loaded by `load_ccxt_order_response`.

The order response is an
[order structure](https://docs.ccxt.com/#/?id=order-structure) generated by CCXT
at the moment when the order is accepted by the exchange.

Schema:
```
 #   Column                  Dtype
---  ------                  -----
 0   info                    object
 1   order                   object
 2   client_order_id         object
 3   timestamp               int64
 4   datetime                object
 5   last_trade_timestamp    float64
 6   lastUpdateTimestamp     int64
 7   symbol                  object
 8   order_type              object
 9   time_in_force           object
 10  post_only               bool
 11  reduce_only             bool
 12  side                    object
 13  order_price             float64
 14  triggerPrice            object
 15  order_amount            float64
 16  cost                    float64
 17  average                 float64
 18  filled                  float64
 19  remaining               float64
 20  status                  object
 21  fee                     object
 22  trades                  object
 23  fees                    object
 24  stop_price              object
 25  takeProfitPrice         object
 26  stopLossPrice           object
 27  order_update_timestamp  object
 28  order_update_datetime   datetime64[ns, UTC]
```

# child_order_fills

## ccxt_fills

Loaded by `load_ccxt_fills`

[CCXT order structures](https://docs.ccxt.com/#/?id=order-structure) for orders
that have been filled/canceled. Can overlap with `ccxt_order_response` for
orders executed immediately.
```
 #   Column                  Dtype
---  ------                  -----
 0   info                    object
 1   order                   object
 2   client_order_id         object
 3   timestamp               int64
 4   datetime                object
 5   last_trade_timestamp    float64
 6   lastUpdateTimestamp     int64
 7   symbol                  object
 8   order_type              object
 9   time_in_force           object
 10  post_only               bool
 11  reduce_only             bool
 12  side                    object
 13  order_price             float64
 14  triggerPrice            object
 15  order_amount            float64
 16  cost                    float64
 17  average                 float64
 18  filled                  float64
 19  remaining               float64
 20  status                  object
 21  fee                     object
 22  trades                  object
 23  fees                    object
 24  stop_price              object
 25  takeProfitPrice         object
 26  stopLossPrice           object
 27  order_update_timestamp  object
 28  order_update_datetime   datetime64[ns, UTC]
```

## ccxt_trades

Loaded by `load_ccxt_trades`.

The trades are CCXT
[trade structures](https://docs.ccxt.com/#/README?id=trade-structure) that
contain information on individual trades conducted on the exchange. One order
can correspond to multiple trades.

Schema:
```
 #   Column            Dtype
---  ------            -----
 0   timestamp         datetime64[ns, UTC]
 1   datetime          datetime64[ns, UTC]
 2   symbol            object
 3   asset_id          int64
 4   id                int64
 5   order             int64
 6   side              object
 7   takerOrMaker      object
 8   price             float64
 9   amount            float64
 10  cost              float64
 11  transaction_cost  float64
 12  fees_currency     object
 13  realized_pnl      float64
 14  first_timestamp   datetime64[ns, UTC]
 15  last_timestamp    datetime64[ns, UTC]
 16  first_datetime    datetime64[ns, UTC]
 17  last_datetime     datetime64[ns, UTC]
 18  buy_count         int64
 19  sell_count        int64
 20  taker_count       int64
 21  maker_count       int64
 22  buy_volume        float64
 23  sell_volume       float64
 24  taker_volume      float64
 25  maker_volume      float64
 26  buy_notional      float64
 27  sell_notional     float64
 28  taker_notional    float64
 29  maker_notional    float64
```

## oms_fills

Loaded by `load_oms_fills`.

`oms.Fill` object serialized as a JSON file. Fills represent fills for parent
orders.
```
 #   Column                  Dtype
---  ------                  -----
 0   asset_id                int64
 1   fill_id                 int64
 2   timestamp               datetime64[ns, UTC]
 3   num_shares              float64
 4   price                   float64
```


# exchange_markets

Loaded by `load_exchange_markets`.

The exchange_markets log file has the [exchange structure](https://docs.ccxt.com/#/?id=exchange-structure). It contains various properties and methods allocated to different type of exchanges.

Schema:
```
{
    'id':   'exchange'                   // lowercase string exchange id
    'name': 'Exchange'                   // human-readable string
    'countries': [ 'US', 'CN', 'EU' ],   // array of ISO country codes
    'urls': {
        'api': 'https://api.example.com/data',  // string or dictionary of base API URLs
        'www': 'https://www.example.com'        // string website URL
        'doc': 'https://docs.example.com/api',  // string URL or array of URLs
    },
    'version':         'v1',             // string ending with digits
    'api':             { ... },          // dictionary of api endpoints
    'has': {                             // exchange capabilities
        'CORS': false,
        'cancelOrder': true,
        'createDepositAddress': false,
        'createOrder': true,
        'fetchBalance': true,
        'fetchCanceledOrders': false,
        'fetchClosedOrder': false,
        'fetchClosedOrders': false,
        'fetchCurrencies': false,
        'fetchDepositAddress': false,
        'fetchMarkets': true,
        'fetchMyTrades': false,
        'fetchOHLCV': false,
        'fetchOpenOrder': false,
        'fetchOpenOrders': false,
        'fetchOrder': false,
        'fetchOrderBook': true,
        'fetchOrders': false,
        'fetchStatus': 'emulated',
        'fetchTicker': true,
        'fetchTickers': false,
        'fetchBidsAsks': false,
        'fetchTrades': true,
        'withdraw': false,
    },
    'timeframes': {                      // empty if the exchange.has['fetchOHLCV'] !== true
        '1m': '1minute',
        '1h': '1hour',
        '1d': '1day',
        '1M': '1month',
        '1y': '1year',
    },
    'timeout':           10000,          // number in milliseconds
    'rateLimit':         2000,           // number in milliseconds
    'userAgent':        'ccxt/1.1.1 ...' // string, HTTP User-Agent header
    'verbose':           false,          // boolean, output error details
    'markets':          { ... }          // dictionary of markets/pairs by symbol
    'symbols':          [ ... ]          // sorted list of string symbols (traded pairs)
    'currencies':       { ... }          // dictionary of currencies by currency code
    'markets_by_id':    { ... },         // dictionary of array of dictionaries (markets) by id
    'currencies_by_id': { ... },         // dictionary of dictionaries (markets) by id
    'apiKey':   '92560ffae9b8a0421...',  // string public apiKey (ASCII, hex, Base64, ...)
    'secret':   '9aHjPmW+EtRRKN/Oi...'   // string private secret key
    'password': '6kszf4aci8r',           // string password
    'uid':      '123456',                // string user id
    'options':          { ... },         // exchange-specific options
    // ... other properties here ...
}
``` 

# leverage_info

Loaded by `load_leverage_info`.

The leverage info has the [leverage tiers structure](https://docs.ccxt.com/#/?id=leverage-tiers-structure). It can be used to obtain the maximum leverage for a market at varying position sizes, the maintenance margin rate, and the max tradeable amount for a market when that information is not available from the market object.

Schema:
```
[
    {
        "tier": 1,                       // tier index
        "notionalCurrency": "USDT",      // the currency that minNotional and maxNotional are in
        "minNotional": 0,                // the lowest amount of this tier // stake = 0.0
        "maxNotional": 10000,            // the highest amount of this tier // max stake amount at 75x leverage = 133.33333333333334
        "maintenanceMarginRate": 0.0065, // maintenance margin rate
        "maxLeverage": 75,               // max available leverage for this market when the value of the trade is > minNotional and < maxNotional
        "info": { ... }                  // Response from exchange
    },
    {
        "tier": 2,
        "notionalCurrency": "USDT",
        "minNotional": 10000,            // min stake amount at 50x leverage = 200.0
        "maxNotional": 50000,            // max stake amount at 50x leverage = 1000.0
        "maintenanceMarginRate": 0.01,
        "maxLeverage": 50,
        "info": { ... },
    },
    ...
    {
        "tier": 9,
        "notionalCurrency": "USDT",
        "minNotional": 20000000,
        "maxNotional": 50000000,
        "maintenanceMarginRate": 0.5,
        "maxLeverage": 1,
        "info": { ... },
    },
]
``` 

# oms_child_orders

Loaded by `load_oms_child_order`.

The child orders are `oms.Order` objects serialized as JSON files, with extra
fields added by the `CcxtBroker`. Child orders are generated from parent orders
during TWAP order execution.
```
 #   Column                  Dtype
---  ------                  -----
 0   creation_timestamp      datetime64[ns, UTC]
 1   asset_id                int64
 2   type_                   object
 3   start_timestamp         datetime64[ns, UTC]
 4   end_timestamp           datetime64[ns, UTC]
 5   curr_num_shares         float64
 6   diff_num_shares         float64
 7   tz                      object
 8   extra_params            object
 9   passivity_factor        float64
 10  latest_bid_price        float64
 11  latest_ask_price        float64
 12  bid_price_mean          float64
 13  ask_price_mean          float64
 14  used_bid_price          object
 15  used_ask_price          object
 16  exchange_timestamp      datetime64[ns, UTC]
 17  knowledge_timestamp     datetime64[ns, UTC]
 18  end_download_timestamp  datetime64[ns, UTC]
 19  limit_price             float64
 20  ccxt_id                 int64
 21  name                    int64
 22  attempt_num             int64
```

# oms_parent_orders

Loaded by `load_oms_parent_order`.

The parent orders are `oms.Order` objects serialized as JSON files.

Schema:
```
 #   Column              Dtype
---  ------              -----
 0   creation_timestamp  datetime64[ns, UTC]
 1   asset_id            int64
 2   type_               object
 3   start_timestamp     datetime64[ns, UTC]
 4   end_timestamp       datetime64[ns, UTC]
 5   curr_num_shares     float64
 6   diff_num_shares     float64
 7   tz                  object
 8   extra_params        object
```

# positions

Loaded by `load_positions`.

The positions log have information about positions currently held in contract markets. The position log file has the [position structure](https://docs.ccxt.com/#/README?id=positions)

Schema:
```
{
   'info': { ... },             // json response returned from the exchange as is
   'id': '1234323',             // string, position id to reference the position, similar to an order id
   'symbol': 'BTC/USD',         // uppercase string literal of a pair of currencies
   'timestamp': 1607723554607,  // integer unix time since 1st Jan 1970 in milliseconds
   'datetime': '2020-12-11T21:52:34.607Z',  // ISO8601 representation of the unix time above
   'isolated': true,            // boolean, whether or not the position is isolated, as opposed to cross where margin is added automatically
   'hedged': false,             // boolean, whether or not the position is hedged, i.e. if trading in the opposite direction will close this position or make a new one
   'side': 'long',              // string, long or short
   'contracts': 5,              // float, number of contracts bought, aka the amount or size of the position
   'contractSize': 100,         // float, the size of one contract in quote units
   'entryPrice': 20000,         // float, the average entry price of the position
   'markPrice': 20050,          // float, a price that is used for funding calculations
   'notional': 100000,          // float, the value of the position in the settlement currency
   'leverage': 100,             // float, the leverage of the position, related to how many contracts you can buy with a given amount of collateral
   'collateral': 5300,          // float, the maximum amount of collateral that can be lost, affected by pnl
   'initialMargin': 5000,       // float, the amount of collateral that is locked up in this position
   'maintenanceMargin': 1000,   // float, the mininum amount of collateral needed to avoid being liquidated
   'initialMarginPercentage': 0.05,      // float, the initialMargin as a percentage of the notional
   'maintenanceMarginPercentage': 0.01,  // float, the maintenanceMargin as a percentage of the notional
   'unrealizedPnl': 300,        // float, the difference between the market price and the entry price times the number of contracts, can be negative
   'liquidationPrice': 19850,   // float, the price at which collateral becomes less than maintenanceMargin
   'marginMode': 'cross',       // string, can be cross or isolated
   'percentage': 3.32,          // float, represents unrealizedPnl / initialMargin * 100
}
```

# reduce_only

## ccxt_child_order_responses

Loaded by `load_ccxt_order_response` with param `reduce_only = True`.

It is same as [ccxt_order_responses](#ccxt_order_responses) but it is logged only when flatten script is called to clear all the positions.

## oms_child_orders

Loaded by `load_oms_child_order` with param `reduce_only = True`.

It is same as [oms_child_orders](#oms_child_orders) but it is logged only when flatten script is called to clear all the positions.